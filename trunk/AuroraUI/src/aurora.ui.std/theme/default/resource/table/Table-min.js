$A.Table=Ext.extend($A.Component,{bgc:"background-color",scor:"#dfeaf5",ocor:"#ffe3a8",cecls:"table-cell-editor",nbcls:"item-notBlank",constructor:function(a){$A.Table.superclass.constructor.call(this,a)},initComponent:function(a){$A.Table.superclass.initComponent.call(this,a);this.tbody=this.wrap.child("tbody");this.fb=this.wrap.child("tfoot");this.initTemplate()},processListener:function(a){$A.Table.superclass.processListener.call(this,a);this.tbody[a]("click",this.onClick,this)},processDataSetLiestener:function(a){var b=this.dataset;if(b){b[a]("update",this.onUpdate,this);b[a]("add",this.onAdd,this);b[a]("load",this.onLoad,this);b[a]("valid",this.onValid,this);b[a]("remove",this.onRemove,this);b[a]("clear",this.onLoad,this)}},initEvents:function(){$A.Table.superclass.initEvents.call(this)},bind:function(a){if(typeof(a)==="string"){a=$(a);if(!a){return}}this.dataset=a;this.processDataSetLiestener("on");this.onLoad()},initTemplate:function(){this.cellTpl=new Ext.Template('<div class="table-cell {cellcls}" id="'+this.id+'_{name}_{recordid}">{text}</div>')},createRow:function(b,c){var f=this.tbody.dom.insertRow(-1);var e=this.parseCss(this.renderRow(b,c));f.id=this.id+"-"+b.id;f.style.cssText=e.style;f.className=(c%2==0?"table-row-alt ":"")+e.cls;for(var d=0,a=this.columns.length;d<a;d++){this.createCell(f,this.columns[d],b)}},createEmptyRow:function(){this.emptyRow=this.tbody.dom.insertRow(-1);for(var b=0,a=this.columns.length;b<a;b++){var c=this.emptyRow.insertCell(-1);c.innerHTML="&#160;";Ext.fly(c).set({atype:"table-cell",dataindex:this.columns[b].name,style:"text-align:"+(this.columns[b].align||"left")+";visibility:visible;"})}},removeEmptyRow:function(){if(this.emptyRow){this.tbody.dom.removeChild(this.emptyRow)}},createCell:function(e,c,b){var f=b.getMeta().getField(c.name);if(f&&Ext.isEmpty(b.data[c.name])&&b.isNew==true&&f.get("required")==true){a=a+" "+this.nbcls}var d=this.getEditor(c,b),g=e.insertCell(-1),a=(d!=""?"table-cell-editor":"");Ext.fly(g).set({atype:"table-cell",recordid:b.id,dataindex:c.name,style:"text-align:"+(c.align||"left")+";visibility:visible;"});g.innerHTML=this.cellTpl.applyTemplate({text:this.renderText(b,c,b.data[c.name]),cellcls:a,name:c.name,recordid:b.id})},setEditor:function(b,c){var a=this.findColByName(b);a.editor=c;this.focusdiv=Ext.get(this.id+"_"+b+"_"+this.selectRecord.id);if(this.focusdiv){(c=="")?this.focusdiv.removeClass(this.cecls):this.focusdiv.addClass(this.cecls)}},getEditor:function(d,b){var c=d.editor||"";if(d.editorfunction){var a=window[d.editorfunction];if(a==null){alert("未找到"+d.editorfunction+"方法!");return null}c=a.call(window,b,d.name)}return c},showEditor:function(j,a){if(j==-1){return}var c=this.findColByName(a);if(!c){return}var e=this.dataset.getAt(j);if(!e){return}if(e.id!=this.selectedId){}this.selectRow(j);var g=this.getEditor(c,e);this.setEditor(a,g);if(g!=""&&($(g) instanceof $A.CheckBox)){var h=this.dataset.getField(a);var d=h.getPropertity("checkedvalue");var b=h.getPropertity("uncheckedvalue");var i=e.get(a);e.set(a,i==d?b:d)}else{if(g){var f=this;setTimeout(function(){var l=e.get(a);f.currentEditor={record:e,ov:l,name:a,editor:$(g)};var k=f.currentEditor.editor;if(k){f.positionEditor();k.isFireEvent=true;k.isHidden=false;k.bind(f.dataset,a);k.render(e);k.focus();Ext.fly(document.documentElement).on("mousedown",f.onEditorBlur,f);Ext.fly(window).on("resize",f.positionEditor,f)}f.fireEvent("editorshow",f,k,j,a,e)},1)}}},positionEditor:function(){var a=this.currentEditor.editor,d=this.focusdiv,c=d.getXY(),b=this;a.setHeight(d.getHeight()-2);a.setWidth(d.getWidth()-5<22?22:(d.getWidth()-5));a.move(c[0],c[1]);if(a.isExpanded&&a.isExpanded()){if(Ext.isIE){if(this.t){clearTimeout(this.t)}this.t=setTimeout(function(){a.syncPopup()},1)}else{a.syncPopup()}}},hideEditor:function(){if(this.currentEditor&&this.currentEditor.editor){var a=this.currentEditor.editor;a.un("blur",this.onEditorBlur,this);var b=true;if(a.canHide){b=a.canHide()}if(b){Ext.fly(document.documentElement).un("mousedown",this.onEditorBlur,this);Ext.fly(window).un("resize",this.positionEditor,this);var a=this.currentEditor.editor;a.move(-10000,-10000);a.isFireEvent=false;a.isHidden=true}}},selectRow:function(d,b){var a=this.dataset.getAt(d);this.selectedId=a.id;if(this.selectTr){this.selectTr.setStyle(this.bgc,"")}this.selectTr=Ext.get(this.id+"-"+a.id);if(this.selectTr){this.selectTr.setStyle(this.bgc,this.scor)}var c=(this.dataset.currentPage-1)*this.dataset.pagesize+d+1;this.selectRecord=a;if(b!==false&&c!=null){this.dataset.locate.defer(5,this.dataset,[c,false])}},drawFootBar:function(b){if(!this.fb){return}b=[].concat((b)?b:this.columns);var a=this;Ext.each(b,function(h){var e=typeof(h)==="string"?a.findColByName(h):h;if(e&&e.footerrenderer){var d=e.name;var g=$A.getRenderer(e.footerrenderer);if(g==null){alert("未找到"+e.footerrenderer+"方法!");return}var c=g.call(window,a.dataset.data,d);var f=a.fb.child("td[dataindex="+d+"]");f.update(c)}})},findColByName:function(d){var b;for(var e=0,a=this.columns.length;e<a;e++){var f=this.columns[e];if(f.name&&f.name.toLowerCase()===d.toLowerCase()){b=f;break}}return b},parseCss:function(c){var e="",a="";if(Ext.isArray(c)){for(var b=0;b<c.length;b++){var d=this.parseCss(c[b]);e+=";"+d.style;a+=" "+d.cls}}else{if(typeof c=="string"){isStyle=!!c.match(/^([^,:;]+:[^:;]+;)*[^,:;]+:[^:;]+;*$/);a=isStyle?"":c;e=isStyle?c:""}}return{style:e,cls:a}},renderText:function(a,b,e){var d=b.renderer;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return e}e=c.call(window,e,a,b.name);return e==null?"":e}return e==null?"":e},renderRow:function(a,e){var d=this.rowrenderer,b=null;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return b}b=c.call(window,a,e);return !b?"":b}return b},renderEditor:function(f,b,e,d){var a=this.createCell(e,b,false);f.parent().update(a)},onClick:function(g){var f=Ext.fly(g.target).findParent("td");if(f){var c=Ext.fly(f).getAttributeNS("","atype");var d=Ext.fly(f).getAttributeNS("","recordid");if(c=="table-cell"){var a=this.dataset.findById(d);var h=this.dataset.indexOf(a);var b=Ext.fly(f).getAttributeNS("","dataindex");this.showEditor(h,b);this.fireEvent("cellclick",this,h,b,a);this.fireEvent("rowclick",this,h,a)}}},onUpdate:function(b,f,a,k){if(this.focusdiv){var h=this.findColByName(a);var g=this.getEditor(h,f);if(g!=""&&($(g) instanceof $A.CheckBox)){this.renderEditor(this.focusdiv,f,h,g)}else{var m=this.renderText(f,h,k);this.focusdiv.update(m)}}var n=this.columns;for(var e=0,d=n.length;e<d;e++){var h=n[e];if(h.name!=a){var j=Ext.get(this.id+"_"+h.name+"_"+f.id);if(j){if(h.editorfunction){var g=this.getEditor(h,f);this.renderEditor(j,f,h,g)}if(h.renderer){var m=this.renderText(f,h,f.get(h.name));j.update(m)}}}}this.drawFootBar(a)},onLoad:function(){this.clearBody();var a=this.dataset.data.length;if(a==0){this.createEmptyRow()}for(var b=0;b<a;b++){this.createRow(this.dataset.getAt(b),b)}this.drawFootBar()},onValid:function(e,a,b,d){var g=this.findColByName(b);if(g){var f=Ext.get(this.id+"_"+b+"_"+a.id);if(f){if(d==false){f.addClass("item-invalid")}else{f.removeClass([this.nbcls,"item-invalid"])}}}},onAdd:function(c,a,b){this.removeEmptyRow();this.createRow(a,this.dataset.data.length-1);this.selectRow(this.dataset.indexOf(a))},onRemove:function(c,a,b){var d=Ext.get(this.id+"-"+a.id);if(d){d.remove()}this.selectTr=null},clearBody:function(){while(this.tbody.dom.childNodes.length){this.tbody.dom.removeChild(this.tbody.dom.firstChild)}},onEditorBlur:function(a){if(this.currentEditor&&!this.currentEditor.editor.isEventFromComponent(a.target)){this.hideEditor()}}});