$A.MenuBar=Ext.extend($A.Component,{constructor:function(a){this.isActive=false,this.needHide=false,this.children=[],this.selectIndex=null,this.altKeyAccess=false;$A.MenuBar.superclass.constructor.call(this,a);this.handlerfield=a.handlerfield||"handler";this.menutype=a.menutype||"type";this.checked=a.checked||"checked"},initComponent:function(a){$A.MenuBar.superclass.initComponent.call(this,a);if(a.focus){Ext.fly(a.focus).set({tabIndex:"-1"});Ext.fly(a.focus).setStyle({outline:"none"})}},processListener:function(a){$A.MenuBar.superclass.processListener.call(this,a);Ext.fly(document)[a]("mousedown",this.onMouseDown,this);Ext.fly(document)[a]("mouseup",this.onMouseUp,this);Ext.getBody()[a]("selectstart",this.preventMenuAndSelect,this);Ext.getBody()[a]("contextmenu",this.preventMenuAndSelect,this);if(a=="on"){Ext.onReady(function(b){this.processIframeListener(b)}.createDelegate(this,[a]))}else{this.processIframeListener(a)}},processIframeListener:function(b){var c=document.getElementsByTagName("iframe");for(var a=0;c[a];a++){Ext.fly(c[a])[b]("load",function(d){Ext.fly(d.contentWindow.document)[b]("mousedown",this.onMouseDown,this);Ext.fly(d.contentWindow.document)[b]("mouseup",this.onMouseUp,this)}.createDelegate(this,[c[a]]));if(this.urltarget&&this.urltarget==c[a].name){this.targetFrame=c[a]}}},processDataSetLiestener:function(a){var b=this.dataset;if(b){b[a]("update",this.onUpdate,this);b[a]("load",this.onLoad,this)}},bind:function(a){if(typeof(a)==="string"){a=$(a);if(!a){return}}this.dataset=a;this.processDataSetLiestener("on");this.onLoad()},renderText:function(a){if(!this.renderer){return a.get(this.displayfield)}return $A.getRenderer(this.renderer).call(window,a.get(this.displayfield),a,this.context)},onUpdate:function(d,a,b,c){if(b==this.displayfield){a.menu.setText(this.value)}else{if(b==this.checked){a.menu.check(c)}}},onLoad:function(){var c=[],f={},a=this.dataset.data;for(var e=0;a[e];e++){f[a[e].get(this.idfield)]={record:a[e],text:a[e].get(this.displayfield),renderText:this.renderText(a[e]),index:a[e].get(this.sequence)||Number.MAX_VALUE,icon:a[e].get(this.iconfield),dataId:a[e].get(this.idfield)};if(a[e].get(this.menutype)){var d=a[e].get(this.menutype).match(/^([^\[\]]+)\[?([^\[\]]+)?\]?$/);Ext.apply(f[a[e].get(this.idfield)],{type:d[1],checked:a[e].get(this.checked)=="true"||false});if(d[2]){Ext.apply(f[a[e].get(this.idfield)],{groupName:d[2]})}}if(a[e].get(this.handlerfield)){Ext.apply(f[a[e].get(this.idfield)],{listeners:{mouseup:function(h,g){return function(){window[h].apply(window,Ext.toArray(arguments).concat(g))}}(a[e].get(this.handler),a[e])}})}if(a[e].get(this.urlfield)){Ext.apply(f[a[e].get(this.idfield)],{listeners:{submit:this.directURL.createDelegate(this,[a[e].get(this.urlfield),a[e].get(this.displayfield)])}})}}for(var e=0;a[e];e++){var b=a[e].get(this.parentfield);if(!b||b==this.rootid||b<0){c.add(f[a[e].get(this.idfield)])}else{if(!f[b].options){f[b].options=[]}f[b].options.add(f[a[e].get(this.idfield)])}}this.addMenus(c.sort(this.sortOptions))},directURL:function(a,b){if(this.targetFrame){this.targetFrame.setAttribute("src",a+(a.match(/\?/)?"&":"?")+"randomnumber="+Math.floor(Math.random()*100000))}else{if(this.urltarget){window.open(a,this.urltarget)}else{new $A.Window({title:b,url:a,width:Ext.fly(document).child("html").getWidth()-100,height:Ext.fly(document).child("html").getHeight()-100})}}},sortOptions:function(b,a){if(b.options){b.options.sort($A.MenuBar.prototype.sortOptions)}if(a.options){a.options.sort($A.MenuBar.prototype.sortOptions)}return parseFloat(b.index)-parseFloat(a.index)},preventMenuAndSelect:function(a){if(this.isAncestor(a.target)){a.stopEvent();return false}},onMouseDown:function(a){if(this.selectIndex==null||this.children.length==0){return}if(a.button==0){if(this.wrap.contains(a.target)){this.needHide=this.isActive}if(this.isAncestor(a.target)){this.isActive=true;this.children[this.selectIndex].show()}else{this.children[this.selectIndex].inactive();this.children[this.selectIndex].hide();this.isActive=false}}},onMouseUp:function(a){if(this.selectIndex==null||this.children.length==0){return}if(a.button==0){if(this.needHide||!this.isAncestor(a.target)){this.isActive=false;this.children[this.selectIndex].hide()}else{if(!this.isActive){this.children[this.selectIndex].hide()}}}},addMenus:function(b){for(var d=0,a=this.children.length;d<b.length;d++){var e=null,c=this.id+"-node"+a;new Ext.Template(this.childTpl).append(this.wrap.dom,{id:c});e=new Aurora[b[d].options?"Menu":"MenuItem"](Ext.apply(b[d],{id:c,parent:this,bar:this,index:a}));b[d].record.menu=e;delete b[d].record;this.children.push(e);a++}},destroy:function(){delete this.children;delete this.isActive;delete this.needHide;$A.Menu.superclass.destroy.call(this)},isAncestor:function(b){if(this.wrap.dom!=b&&this.wrap.contains(b)){return true}for(var a=0;a<this.children.length;a++){if(this.children[a].isAncestor&&this.children[a].isAncestor(b)){return true}}return false},childTpl:'<LI id="{id}" class="item-menu"></LI>'});$A.MenuItem=Ext.extend($A.Component,{constructor:function(a){this.hasIcon=false;$A.MenuItem.superclass.constructor.call(this,a)},initComponent:function(a){$A.MenuItem.superclass.initComponent.call(this,a);this.el=new Ext.Template(this.parent===this.bar?this.menuBarTpl:this.menuTpl).append(this.wrap.dom,{text:this.renderText,width:"16px"},true);if(this.parent!==this.bar){this.setIcon();if(this.type&&!this.children){this.initMenuType()}}},processListener:function(a){$A.MenuItem.superclass.processListener.call(this,a);this.wrap[a]("mouseup",this.onMouseUp,this)},processMouseOverOut:function(a){this.wrap[a]("mouseover",this.onMouseOver,this);this.wrap[a]("mouseout",this.onMouseOut,this)},initEvents:function(){$A.MenuItem.superclass.initEvents.call(this);this.addEvents("submit","mouseup")},getWidth:function(){return this.wrap.child("td.item-menu-text").getWidth()+(this.parent==this.bar?0:72)},initMenuType:function(){if(this.type=="radio"){this.wrap.child("td.item-menu-icon div").addClass("type-radio")}else{if(this.type=="checkbox"){this.wrap.child("td.item-menu-icon div").addClass("type-checkbox")}}this.check()},check:function(a){this.checked=a;this.wrap.child("td.item-menu-icon div")[this.checked?"addClass":"removeClass"]("check")},getBindingRecord:function(){return this.record},setText:function(a){this.text=a;this.renderText=this.bar.renderText(this.record);this.el.update(this.renderText)},setIcon:function(b){if(!(b||(b=this.icon))||this.type){return}var a=b.match(/^([^\?]*)\??([^?]*)?$/);this.wrap.child("td.item-menu-icon div").setStyle({"background-image":"url("+(a[1].match(/^[\/]{1}/)?this.bar.context:"")+a[1]+")","background-position":a[2]||"0 0"});this.hasIcon=true},submit:function(){if(!this.children){if(this.parent!=this.bar){this.bar.children[this.bar.selectIndex].inactive();this.bar.children[this.bar.selectIndex].hide();this.bar.isActive=false}if(this.type=="checkbox"){this.record.set(this.bar.checked,!this.checked)}else{if(this.type=="radio"){if(this.checked==true){return}this.record.set(this.bar.checked,true);if(this.groupName){for(var a=0,b=this.parent.groups[this.groupName];a<b.length;a++){if(b[a]!=this){b[a].record.set(this.bar.checked,false)}}}}}}this.fireEvent("mouseup",this.bar,this);this.fireEvent("submit",this.bar)},onMouseUp:function(a){if(a.button==0){this.submit()}},onMouseOver:function(a){this.active()},onMouseOut:function(a){if(!this.isActive){this.inactive()}if(this.showIntervalId){clearInterval(this.showIntervalId)}},active:function(){this.wrap.addClass("item-menu-current");if(this.parent.selectIndex===this.index){return}if(this.parent.selectIndex!=null){this.parent.children[this.parent.selectIndex].inactive();if(this.parent==this.bar){this.parent.children[this.parent.selectIndex].hide()}else{setTimeout(this.parent.children[this.parent.selectIndex].hide.createDelegate(this.parent.children[this.parent.selectIndex]),299)}}this.parent.selectIndex=this.index},inactive:function(){this.wrap.removeClass("item-menu-current")},show:function(){},hide:function(){},destroy:function(){delete this.el;delete this.bar;$A.MenuItem.superclass.destroy.call(this)},menuTpl:['<TD class="item-menu-icon" align="center"><DIV></DIV></TD>','<TD class="item-menu-text">{text}</TD>',"<TD></TD>"],menuBarTpl:'<SPAN class="item-menu-text">{text}</SPAN>'});$A.Menu=Ext.extend($A.MenuItem,{constructor:function(a){this.children=[],this.selectIndex=null,this.groups={},this.isActive=false,this.initMenus=false;$A.Menu.superclass.constructor.call(this,a)},initComponent:function(a){$A.Menu.superclass.initComponent.call(this,a);this.shadow=new Ext.Template(this.shadowTpl).append(document.body,{zIndex:9999+this.index},true);this.shadow.addClass("item-menu-hide");this.container=new Ext.Template(this.containerTpl).append(document.body,{zIndex:10000+this.index},true)},addMenus:function(b){if(!this.options){return}var e=0;for(var d=0,a=this.children.length;d<b.length;d++){var f=null,c=this.id+"-node"+a;new Ext.Template(this.childTpl).append(this.container.dom,{id:c});f=new Aurora[b[d].options?"Menu":"MenuItem"](Ext.apply(b[d],{id:c,parent:this,bar:this.bar,index:a}));if(f.groupName){if(!this.groups[f.groupName]){this.groups[f.groupName]=[]}this.groups[f.groupName].add(f)}this.children.push(f);b[d].record.menu=f;delete b[d].record;e=f.getWidth()>e?f.getWidth():e;a++}this.container.setWidth(e)},onMouseOver:function(a){$A.Menu.superclass.onMouseOver.call(this,a);if(this.parent===this.bar){this.show()}else{this.showIntervalId=setInterval(this.show.createDelegate(this),300)}},show:function(){$A.Menu.superclass.show.call(this);if(!this.parent.isActive){return}if(!this.initMenus){this.addMenus(this.options);this.initMenus=true}var i=this.wrap.getXY(),f,e,b=this.container.getWidth(),g=this.container.getHeight(),a=this.wrap.getHeight(),d=this.wrap.getWidth(),h=$A.getViewportHeight()-3,c=$A.getViewportWidth()-3;if(this.parent===this.bar){f=(i[0]+b)>c?((c-b)<0?i[0]:(c-b)):i[0];e=(i[1]+a+g)>h?((i[1]-g)<0?(i[1]+a):(i[1]-g)):(i[1]+a)}else{f=(i[0]+d+b)>c?((i[0]-b)<0?(i[0]+d):(i[0]-b)):(i[0]+d);e=(i[1]+a+g)>h?((h-g)<0?i[1]:(h-g)):i[1]}this.container.moveTo(f,e);this.shadow.moveTo(f+3,e+3);this.container.removeClass("item-menu-hide");this.shadow.removeClass("item-menu-hide");this.shadow.setHeight(this.container.getHeight());this.shadow.setWidth(this.container.getWidth());this.isActive=true;if(this.intervalId){clearInterval(this.intervalId)}},hide:function(){$A.Menu.superclass.hide.call(this);this.container.addClass("item-menu-hide");this.shadow.addClass("item-menu-hide");this.shadow.setHeight(this.container.getHeight());this.shadow.setWidth(this.container.getWidth());this.container.moveTo(0,0);this.shadow.moveTo(0,0);if(this.selectIndex!=null){this.children[this.selectIndex].inactive();this.children[this.selectIndex].hide()}this.isActive=false;this.selectIndex=null},destroy:function(){this.container.remove();this.shadow.remove();delete this.children;delete this.groups;$A.Menu.superclass.destroy.call(this)},isAncestor:function(b){if(this.container.dom!=b&&this.container.contains(b)){return true}for(var a=0;a<this.children.length;a++){if(this.children[a].isAncestor&&this.children[a].isAncestor(b)){return true}}return false},menuTpl:['<TD class="item-menu-icon" align="center"><DIV></DIV></TD>','<TD class="item-menu-text">{text}</TD>','<TD class="item-menu-arrow" align="center"><DIV></DIV></TD>'],containerTpl:'<TABLE cellspacing="0" class="item-menu-container item-menu-hide" style="z-index:{zIndex}"></TABLE>',shadowTpl:'<DIV class="item-shadow" style="z-index:{zIndex}"></DIV>',childTpl:'<TR id="{id}" class="item-menu"></TR>',hSplitTpl:'<TR class="item-menu-h-split"><TD>&nbsp;</TD></TR>'});