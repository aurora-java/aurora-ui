$A.Grid=Ext.extend($A.Component,{cecls:"cell-editor",nbcls:"item-notBlank",constructor:function(a){this.overId=null;this.selectedId=null;this.lockWidth=0;this.autofocus=a.autofocus||true;this.defaultColumnOptions={autoadjust:true,forexport:true,hidden:false,lock:false,resizable:true,rowspan:1,sortable:true,width:100};$A.Grid.superclass.constructor.call(this,a)},initComponent:function(a){$A.Grid.superclass.initComponent.call(this,a);var b=this.wrap;this.wb=Ext.get(this.id+"_wrap");this.fb=this.wb.child("div[atype=grid.fb]");if(this.fb){this.uf=this.fb.child("div[atype=grid.uf]")}this.uc=b.child("div[atype=grid.uc]");this.uh=b.child("div[atype=grid.uh]");this.ub=b.child("div[atype=grid.ub]");this.uht=b.child("table[atype=grid.uht]");this.lc=b.child("div[atype=grid.lc]");this.lh=b.child("div[atype=grid.lh]");this.lb=b.child("div[atype=grid.lb]");this.lht=b.child("table[atype=grid.lht]");this.sp=b.child("div[atype=grid.spliter]");Ext.getBody().insertFirst(this.sp);this.fs=b.child("a[atype=grid.focus]");this.classfiyColumns();this.initTemplate()},processListener:function(a){$A.Grid.superclass.processListener.call(this,a);this.wrap[a]("mouseover",this.onMouseOver,this)[a]("mouseout",this.onMouseOut,this)[a]("click",this.focus,this);if(!(this.canwheel===false)){this.wb[a]("mousewheel",this.onMouseWheel,this)}this.fs[a](Ext.isOpera?"keypress":"keydown",this.handleKeyDown,this);this.ub[a]("scroll",this.syncScroll,this)[a]("click",this.onClick,this)[a]("dblclick",this.onDblclick,this);this.uht[a]("mousemove",this.onUnLockHeadMove,this);this.uh[a]("mousedown",this.onHeadMouseDown,this)[a]("click",this.onHeadClick,this);if(this.lb){this.lb[a]("click",this.onClick,this)[a]("dblclick",this.onDblclick,this)}if(this.lht){this.lht[a]("mousemove",this.onLockHeadMove,this)}if(this.lh){this.lh[a]("mousedown",this.onHeadMouseDown,this)[a]("click",this.onHeadClick,this)}this[a]("cellclick",this.onCellClick,this)},initEvents:function(){$A.Grid.superclass.initEvents.call(this);this.addEvents("render","keydown","dblclick","cellclick","rowclick","editorshow","nexteditorshow")},syncScroll:function(){this.hideEditor();this.uh.dom.scrollLeft=this.ub.dom.scrollLeft;if(this.lb){this.lb.dom.scrollTop=this.ub.dom.scrollTop}if(this.uf){this.uf.dom.scrollLeft=this.ub.dom.scrollLeft}},handleKeyDown:function(c){var a=c.getKey(),b=this.dataset;if(c.ctrlKey&&c.keyCode==86&&this.canpaste){var d=window.clipboardData.getData("text");if(d){Ext.each(d.split("\n"),function(h){var f=h.split("\t");if(f==""){return}var g={},e=0;Ext.each(this.columns,function(i){if(this.isFunctionCol(i.type)){return}if(i.hidden!==true){g[i.name]=f[e];e++}},this);b.create(g)},this)}}else{if(a==38||a==40||a==33||a==34){if(b.loading==true){return}switch(c.getKey()){case 33:b.prePage();break;case 34:b.nextPage();break;case 38:b.pre();break;case 40:b.next();break}}}this.fireEvent("keydown",this,c)},processDataSetLiestener:function(a){var b=this.dataset;if(b){b[a]("ajaxfailed",this.onAjaxFailed,this);b[a]("metachange",this.onRefresh,this);b[a]("update",this.onUpdate,this);b[a]("reject",this.onUpdate,this);b[a]("add",this.onAdd,this);b[a]("submit",this.onBeforSubmit,this);b[a]("submitfailed",this.onAfterSuccess,this);b[a]("submitsuccess",this.onAfterSuccess,this);b[a]("query",this.onBeforeLoad,this);b[a]("load",this.onLoad,this);b[a]("loadfailed",this.onAjaxFailed,this);b[a]("valid",this.onValid,this);b[a]("beforeremove",this.onBeforeRemove,this);b[a]("remove",this.onRemove,this);b[a]("clear",this.onLoad,this);b[a]("refresh",this.onRefresh,this);b[a]("fieldchange",this.onFieldChange,this);b[a]("indexchange",this.onIndexChange,this);b[a]("select",this.onSelect,this);b[a]("unselect",this.onUnSelect,this);b[a]("selectall",this.onSelectAll,this);b[a]("unselectall",this.onUnSelectAll,this)}},bind:function(a){if(typeof(a)==="string"){a=$(a);if(!a){return}}this.dataset=a;if(a.autopagesize===true){a.pagesize=Math.round(((this.ub.getHeight()||parseFloat(this.ub.dom.style.height))-16)/25)}this.processDataSetLiestener("on");this.onLoad()},initTemplate:function(){this.rowTdTpl=new Ext.Template('<td atype="{atype}" class="grid-rowbox" recordid="{recordid}">');this.rowNumTdTpl=new Ext.Template('<td style="text-align:{align}" class="grid-rownumber" atype="grid-rownumber" recordid="{recordid}">');this.rowNumCellTpl=new Ext.Template('<div style="width:{width}px">{text}</div>');this.tdTpl=new Ext.Template('<td style="visibility:{visibility};text-align:{align}" dataindex="{name}" atype="grid-cell" recordid="{recordid}">');this.cellTpl=new Ext.Template('<div class="grid-cell {cellcls}" style="width:{width}px" id="'+this.id+'_{name}_{recordid}" title="{title}"><span>{text}</span></div>');this.cbTpl=new Ext.Template('<center><div class="{cellcls}" id="'+this.id+'_{name}_{recordid}"></div></center>')},getCheckBoxStatus:function(a,d,c){var g=this.dataset.getField(d),b=g.getPropertity("checkedvalue"),e=g.getPropertity("uncheckedvalue"),f=a.data[d];return"item-ckb-"+(c?"readonly-":"")+((f&&f==b)?"c":"u")},createTemplateData:function(b,a){return{width:b.width-2,recordid:a.id,visibility:b.hidden===true?"hidden":"visible",name:b.name}},createCell:function(b,g,i){var e=this.createTemplateData(b,g),m,d=this.tdTpl,o="",c=b.type,f,h=this.getEditor(b,g),k=[];if(h!=""){var j=$A.CmpManager.get(h);if(j&&(j instanceof $A.CheckBox)){c="cellcheck"}else{o=this.cecls}}else{if(b.name&&Ext.isDefined(g.getField(b.name).get("checkedvalue"))){c="cellcheck";f=true}}if(c=="rowcheck"||c=="rowradio"){f=this.dataset.execSelectFunction(g)?"":"-readonly";d=this.rowTdTpl;e=Ext.apply(e,{align:"center",atype:c=="rowcheck"?"grid.rowcheck":"grid.rowradio",cellcls:c=="rowcheck"?"grid-ckb item-ckb"+f+"-u":"grid-radio item-radio-img"+f+"-u"});m=this.cbTpl}else{if(c=="cellcheck"){e=Ext.apply(e,{align:"center",cellcls:"grid-ckb "+this.getCheckBoxStatus(g,b.name,f)});m=this.cbTpl}else{var l=g.getMeta().getField(b.name);if(l&&Ext.isEmpty(g.data[b.name])&&g.isNew==true&&l.get("required")==true){o=o+" "+this.nbcls}var a=(o.indexOf(this.cecls)!=-1)?5:2,n=this.renderText(g,b,g.data[b.name]);e=Ext.apply(e,{align:b.align||"left",cellcls:o,width:e.width-a,text:n,title:String(n).replace(/<[^<>]*>/mg,"")});m=this.cellTpl;if(c=="rownumber"){d=this.rowNumTdTpl;m=this.rowNumCellTpl}}}if(i){k.push(d.applyTemplate(e))}k.push(m.applyTemplate(e));if(i){k.push("</td>")}return k.join("")},createRow:function(d,g,f,e){var c=this.parseCss(this.renderRow(e,g)),h=['<tr id="',this.id,"$",d,"-",e.id,'" class="',(g%2==0?"":"row-alt"),c.cls,'"','style="',c.style,'">'];for(var b=0,a=f.length;b<a;b++){h.push(this.createCell(f[b],e,true))}h.push("</tr>");return h.join("")},parseCss:function(c){var e="",a="";if(Ext.isArray(c)){for(var b=0;b<c.length;b++){var d=this.parseCss(c[b]);e+=";"+d.style;a+=" "+d.cls}}else{if(typeof c=="string"){var f=!!c.match(/^([^,:;]+:[^:;]+;)*[^,:;]+:[^:;]+;*$/);a=f?"":c;e=f?c:""}}return{style:e,cls:a}},renderText:function(a,b,e){var d=b.renderer;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return e}e=c.call(window,e,a,b.name);return e==null?"":e}return e==null?"":e},renderRow:function(a,e){var d=this.rowrenderer,b=null;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return b}b=c.call(window,a,e);return !b?"":b}return b},createTH:function(d){var f=['<tr class="grid-hl">'];for(var b=0,a=d.length;b<a;b++){var e=d[b];f.push('<th dataindex="',e.name,'" style="height:0px;width:',e.hidden===true?0:e.width,'px"></th>')}f.push("</tr>");return f.join("")},onBeforeRemove:function(){$A.Masker.mask(this.wb,_lang["grid.mask.remove"])},onBeforeLoad:function(){this.ub.scrollTo("left",0);this.uh.scrollTo("left",0);$A.Masker.mask(this.wb,_lang["grid.mask.loading"])},onBeforSubmit:function(a){$A.Masker.mask(this.wb,_lang["grid.mask.submit"])},onAfterSuccess:function(){$A.Masker.unmask(this.wb)},preLoad:function(){},onLoad:function(){this.isSelectAll=false;this.clearDomRef();this.preLoad();var a=this.wrap.removeClass("grid-select-all").child("div[atype=grid.headcheck]");if(a&&this.selectable&&this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,false)}if(this.lb){this.renderLockArea()}this.renderUnLockAread();this.drawFootBar();$A.Masker.unmask(this.wb);this.fireEvent("render",this)},clearDomRef:function(){this.selectlockTr=null;this.selectUnlockTr=null},onAjaxFailed:function(b,a){$A.Masker.unmask(this.wb)},onMouseWheel:function(b){b.stopEvent();if(this.editing==true){return}var c=b.getWheelDelta(),a=this.dataset;if(c>0){a.pre()}else{if(c<0){a.next()}}},focus:function(){this.fs.focus()},renderLockArea:function(){var c=this.lockColumns,d=['<TABLE cellSpacing="0" atype="grid.lbt" cellPadding="0" border="0"  width="',this.lockWidth,'"><TBODY>',this.createTH(c)];for(var b=0,a=this.dataset.data.length;b<a;b++){d.push(this.createRow("l",b,c,this.dataset.getAt(b)))}d.push('</TBODY></TABLE><DIV style="height:17px"></DIV>');this.lb.update(d.join(""));this.lbt=this.lb.child("table[atype=grid.lbt]")},renderUnLockAread:function(){var c=this.unlockColumns,d=['<TABLE cellSpacing="0" atype="grid.ubt" cellPadding="0" border="0" width="',this.unlockWidth,'"><TBODY>',this.createTH(c)];for(var b=0,a=this.dataset.data.length;b<a;b++){d.push(this.createRow("u",b,c,this.dataset.getAt(b)))}d.push("</TBODY></TABLE>");this.ub.update(d.join(""));this.ubt=this.ub.child("table[atype=grid.ubt]")},isOverSplitLine:function(a){var b=0,c=false;this.overColIndex=-1;Ext.each(this.columns,function(e,d){if(e.hidden!==true){b+=e.width}if(a<b+3&&a>b-3&&e.resizable!=false){c=true;this.overColIndex=d;return false}},this);return c},onRefresh:function(){this.onLoad(false);if(this.selectable){for(var b=0,d=this.dataset,c=d.selected,a=c.length;b<a;b++){this.onSelect(d,c[b])}}},onIndexChange:function(c,b){var a=this.getDataIndex(b.id);if(a==-1){return}this.selectRow(a,false)},isFunctionCol:function(a){return a=="rowcheck"||a=="rowradio"||a=="rownumber"},onAdd:function(c,g,r){var e=this.columns,p=r===this.dataset.data.length-1,h=this.parseCss(this.renderRow(g,r)),m="row-alt",q=(r%2==0?"":m+" ")+h.cls;if(this.lbt){var b=document.createElement("tr"),o=this.lbt.dom.tBodies[0];b.id=this.id+"$l-"+g.id;b.className=q;Ext.fly(b).set({style:h.style});Ext.each(e,function(i){if(i.lock===true){var s=document.createElement("td");if(i.type=="rowcheck"){Ext.fly(s).set({recordid:g.id,atype:"grid.rowcheck"});s.className="grid-rowbox";if(this.isSelectAll){s.className+=" item-ckb-self"}}else{if(i.type=="rowradio"){Ext.fly(s).set({recordid:g.id,atype:"grid.rowradio"});s.className="grid-rowbox"}else{if(i.hidden){s.style.visibility="hidden"}s.style.textAlign=i.align||"left";if(!this.isFunctionCol(i.type)){s.dataindex=i.name}var l={recordid:g.id,atype:"grid-cell"};if(i.type=="rownumber"){s.className="grid-rownumber";l.atype="grid-rownumber"}Ext.fly(s).set(l)}}s.innerHTML=this.createCell(i,g,false);b.appendChild(s)}},this);if(p){o.appendChild(b)}else{var j=Ext.fly(o).query("tr[class!=grid-hl]");for(var f=r,d=j.length;f<d;f++){var k=Ext.fly(j[f]).toggleClass(m);k.select(".grid-rownumber div").each(function(i){i.update(Number(i.dom.innerHTML)+1)});k.select(".table-rowbox").each(function(i){this.setSelectStatus(this.dataset.findById(i.getAttributeNS("","recordid")))},this)}o.insertBefore(b,j[r])}}var a=document.createElement("tr"),n=this.ubt.dom.tBodies[0];a.id=this.id+"$u-"+g.id;a.className=q;Ext.fly(a).set({style:h.style});Ext.each(e,function(i){if(i.lock!==true){var l=document.createElement("td");l.style.visibility=i.hidden===true?"hidden":"visible";l.style.textAlign=i.align||"left";Ext.fly(l).set({dataindex:i.name,recordid:g.id,atype:"grid-cell"});l.innerHTML=this.createCell(i,g,false);a.appendChild(l)}},this);if(p){n.appendChild(a)}else{var j=Ext.fly(n).query("tr[class!=grid-hl]");for(var f=r,d=j.length;f<d;f++){Ext.fly(j[f]).toggleClass(m)}n.insertBefore(a,j[r])}this.setSelectStatus(g)},renderEditor:function(f,b,e,d){var a=this.createCell(e,b,false);f.parent("td").update(a)},onUpdate:function(f,a,b,e){this.setSelectStatus(a);var h=Ext.get([this.id,b,a.id].join("_"));if(h){var g=this.findColByName(b),d=this.getEditor(g,a);if(d!=""&&($(d) instanceof $A.CheckBox)){this.renderEditor(h,a,g,d)}else{h.update(this.renderText(a,g,e))}}Ext.each(this.columns,function(j){if(j.name!=b){var i=Ext.get([this.id,j.name,a.id].join("_"));if(i){if(j.editorfunction){this.renderEditor(i,a,j,this.getEditor(j,a))}if(j.renderer){i.update(this.renderText(a,j,a.get(j.name)))}}}},this);this.drawFootBar(b)},onValid:function(e,a,b,d){var g=this.findColByName(b);if(g){var f=Ext.get([this.id,b,a.id].join("_"));if(f){if(d==false){f.addClass("item-invalid")}else{f.removeClass([this.nbcls,"item-invalid"])}}}},onRemove:function(d,a,b){var c=Ext.get(this.id+"$l-"+a.id),e=Ext.get(this.id+"$u-"+a.id);if(c){c.remove()}if(e){e.remove()}if(Ext.isIE||Ext.isIE9){this.syncScroll()}this.clearDomRef();$A.Masker.unmask(this.wb);this.drawFootBar()},onClear:function(){},onFieldChange:function(d,a,e,b,c){if(b=="required"){var f=Ext.get([this.id,e.name,a.id].join("_"));if(f){f[c==true?"addClass":"removeClass"](this.nbcls)}}},getDataIndex:function(c){for(var b=0,d=this.dataset.data,a=d.length;b<a;b++){if(d[b].id==c){return b}}return -1},onSelect:function(c,b,d){if(!b||d){return}var a=Ext.get(this.id+"__"+b.id);a.parent(".grid-rowbox").addClass("item-ckb-self");if(a){if(this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,true)}else{this.setRadioStatus(a,true);this.dataset.locate((this.dataset.currentPage-1)*this.dataset.pagesize+this.dataset.indexOf(b)+1)}this.setSelectStatus(b)}},onUnSelect:function(c,b,d){if(!b||d){return}var a=Ext.get(this.id+"__"+b.id);a.parent(".grid-rowbox").addClass("item-ckb-self");if(a){if(this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,false)}else{this.setRadioStatus(a,false)}this.setSelectStatus(b)}},onSelectAll:function(){this.clearChecked();this.isSelectAll=true;this.isUnSelectAll=false;this.wrap.addClass("grid-select-all")},onUnSelectAll:function(){this.clearChecked();this.isSelectAll=false;this.isUnSelectAll=true;this.wrap.removeClass("grid-select-all")},clearChecked:function(){var a=this.wrap;a.select(".item-ckb-self .item-ckb-c").replaceClass("item-ckb-c","item-ckb-u");a.select(".item-ckb-self").removeClass("item-ckb-self")},onDblclick:function(h,c){var g=Ext.fly(c).parent("td[atype=grid-cell]");if(g){var f=this.dataset,d=g.getAttributeNS("","recordid"),a=f.findById(d),i=f.indexOf(a),b=g.getAttributeNS("","dataindex");this.fireEvent("dblclick",this,a,i,b)}},onClick:function(g,j){var h=Ext.fly(j).parent("td");if(h){var c=h.getAttributeNS("","atype"),i=h.getAttributeNS("","recordid"),b=this.dataset;if(c=="grid-cell"){var f=b.findById(i),k=b.indexOf(f),a=h.getAttributeNS("","dataindex");this.fireEvent("cellclick",this,k,a,f);this.fireEvent("rowclick",this,k,f)}else{if(c=="grid-rownumber"){var f=b.findById(i),k=b.indexOf(f);if(f.id!=this.selectedId){this.selectRow(k)}}else{if(c=="grid.rowcheck"){var d=Ext.get(this.id+"__"+i);if(d.hasClass("item-ckb-readonly-u")||d.hasClass("item-ckb-readonly-c")){return}if(this.isSelectAll&&!d.parent(".item-ckb-self")){d.replaceClass("item-ckb-u","item-ckb-c")}else{if(this.isUnselectAll&&!d.parent(".item-ckb-self")){d.replaceClass("item-ckb-c","item-ckb-u")}}d.hasClass("item-ckb-c")?b.unSelect(i):b.select(i)}else{if(c=="grid.rowradio"){var d=Ext.get(this.id+"__"+i);if(d.hasClass("item-radio-img-readonly-u")||d.hasClass("item-radio-img-readonly-c")){return}b.select(i)}}}}}},onCellClick:function(c,d,b,a,e){this.adjustColumn(b);this.showEditor(d,b,e)},adjustColumn:function(d){var c=this.findColByName(d);if(!c||!c.autoadjust){return}var f=this.wrap.select("tr.grid-hl th[dataindex="+d+"]"),b=Ext.fly(f.elements[0]).getWidth(),a=b,g=12,e=this.width-(this.selectable?23:0)-20;this.wrap.select("td[dataindex="+d+"] span").each(function(h){if(Ext.isIE||Ext.isIE9){h.parent().setStyle("text-overflow","clip")}a=Math.max(h.getWidth()+g,a);if(Ext.isIE||Ext.isIE9){h.parent().setStyle("text-overflow","")}if(a>e){a=e;return false}});if(a>b){this.setColumnSize(d,a)}},setColumnPrompt:function(b,a){this.wrap.select("td.grid-hc[dataindex="+b+"] div").update(a)},setEditor:function(b,c){var a=this.findColByName(b),d=Ext.get([this.id,b,this.selectedId].join("_"));a.editor=c;if(d){if(c==""){d.removeClass(this.cecls)}else{if(!$(c) instanceof $A.CheckBox){d.addClass(this.cecls)}}}},getEditor:function(d,b){var c=d.editor||"";if(d.editorfunction){var a=window[d.editorfunction];if(a==null){alert("未找到"+d.editorfunction+"方法!");return null}c=a.call(window,b,d.name)||""}return c},showEditor:function(j,a,i){if(j==-1){return}var b=this.findColByName(a);if(!b){return}var c=this.dataset.getAt(j);if(!c){return}if(c.id!=this.selectedId){this.selectRow(j)}else{this.focusRow(j)}this.focusColumn(a);var g=this.getEditor(b,c);this.setEditor(a,g);var f=this;if(f.currentEditor){f.currentEditor.editor.el.un("keydown",f.onEditorKeyDown,f);var h=f.currentEditor.focusCheckBox;if(h){h.setStyle("outline","none");f.currentEditor.focusCheckBox=null}}if(g!=""){var e=$(g);setTimeout(function(){var d=c.get(a),m=Ext.get([f.id,a,c.id].join("_")),l=m.getXY();f.currentEditor={record:c,ov:d,name:a,editor:e};e.bind(f.dataset,a);e.render(c);if(e instanceof $A.CheckBox){e.move(-1000,l[1]+5);e.el.on("keydown",f.onEditorKeyDown,f);e.onClick();f.currentEditor.focusCheckBox=m;m.setStyle("outline","1px dotted blue")}else{var k=m.parent();e.move(l[0],l[1]);e.setHeight(k.getHeight()-5);e.setWidth(k.getWidth()-7);e.isEditor=true;e.isFireEvent=true;e.isHidden=false;e.focus();f.editing=true;e.el.on("keydown",f.onEditorKeyDown,f);e.on("select",f.onEditorSelect,f);Ext.get(document.documentElement).on("mousedown",f.onEditorBlur,f);if(i){i.call(window,e)}f.fireEvent("editorshow",f,e,j,a,c)}},10)}},onEditorSelect:function(){var a=this;setTimeout(function(){a.hideEditor()},1)},onEditorKeyDown:function(c){var b=c.keyCode;if(b==27){if(this.currentEditor){var a=this.currentEditor.editor;if(a){a.clearInvalid();a.render(a.binder.ds.getCurrentRecord())}}this.hideEditor()}else{if(b==13){if(!(this.currentEditor&&this.currentEditor.editor&&this.currentEditor.editor instanceof $A.TextArea)){this.showNextEditor()}}else{if(b==9){c.stopEvent();this.showNextEditor()}}}},showNextEditor:function(){this.hideEditor();var n=this;if(n.currentEditor){var k=n.currentEditor.editor;if(k){var q=function(d){if(d instanceof $A.Lov){d.showLovWindow()}},g=n.dataset,f=k.binder.name,a=k.record,t=g.data.indexOf(a),b=null;if(t!=-1){var s=n.columns,c=0,m;for(var j=0,h=s.length;j<h;j++){if(s[j].name==f){c=j+1;break}}for(var j=c,h=s.length;j<h;j++){var e=s[j];if(e.hidden!=true){m=n.getEditor(e,a);if(m!=""){b=e.name;break}}}if(n.currentEditor){var o=n.currentEditor.focusCheckBox;if(o){o.setStyle("outline","none");n.currentEditor.focusCheckBox=null}}if(b){var k=$(m);if(k instanceof $A.CheckBox){n.currentEditor={record:a,ov:a.get(b),name:b,editor:k};setTimeout(function(){k.bind(g,b);k.render(a);var i=Ext.get([n.id,b,a.id].join("_")),d=i.getXY();k.move(-1000,d[1]);k.focus();k.el.on("keydown",n.onEditorKeyDown,n);n.currentEditor.focusCheckBox=i;i.setStyle("outline","1px dotted blue")},10)}else{n.fireEvent("cellclick",n,t,b,a,q)}}else{var p=g.getAt(t+1);if(!p&&n.autoappend!==false){g.create();p=g.getAt(t+1)}if(p){n.selectRow(t+1);for(var j=0,h=s.length;j<h;j++){var e=s[j],m=n.getEditor(e,p);if(m!=""){var k=$(m),b=e.name;if(k instanceof $A.CheckBox){n.currentEditor={record:p,ov:p.get(b),name:b,editor:k};setTimeout(function(){k.bind(g,b);k.render(p);var i=Ext.get([n.id,b,p.id].join("_")),d=i.getXY();k.move(-1000,d[1]);k.focus();k.el.on("keydown",n.onEditorKeyDown,n);n.currentEditor.focusCheckBox=i;i.setStyle("outline","1px dotted blue")},10)}else{n.fireEvent("cellclick",n,t+1,b,p,q)}break}}}}}n.fireEvent("nexteditorshow",n,t,b)}}},focusRow:function(f){var e=25,a=this.ub,c=a.getScroll().top,d=a.getHeight(),b=a.dom.scrollWidth>a.dom.clientWidth?16:0;if(f*e<c){a.scrollTo("top",f*e-1)}else{if((f+1)*e>(c+d-b)){a.scrollTo("top",(f+1)*e-d+b)}}if(this.autofocus){this.focus()}},focusColumn:function(d){var a=25,b=this.ub,n=this.columns,f=b.getScroll().left;var o=0,k=0,e=0,j;for(var h=0,g=n.length;h<g;h++){var m=n[h];if(m.name==d){k=m.width}if(m.hidden!==true){if(m.lock===true){e+=m.width}else{if(k==0){o+=m.width}}}}j=o+k;if(o<f){b.scrollTo("left",o)}else{if((j-f)>(this.width-e)){b.scrollTo("left",j-this.width+e+(b.dom.scrollHeight>b.dom.clientHeight?16:0))}}if(this.autofocus){this.focus()}},hideEditor:function(){if(this.currentEditor&&this.editing){var a=this.currentEditor.editor;if(a){if(!a.canHide||a.canHide()){a.el.un("keydown",this.onEditorKeyDown,this);a.un("select",this.onEditorSelect,this);Ext.get(document.documentElement).un("mousedown",this.onEditorBlur,this);a.move(-10000,-10000);a.onBlur();a.isFireEvent=false;a.isHidden=true;this.editing=false}}}},onEditorBlur:function(b,a){if(this.currentEditor&&!this.currentEditor.editor.isEventFromComponent(a)){this.hideEditor.defer(Ext.isIE9?10:0,this)}},onLockHeadMove:function(a){this.hmx=a.xy[0]-this.lht.getXY()[0];if(this.isOverSplitLine(this.hmx)){this.lh.setStyle("cursor","w-resize")}else{this.lh.setStyle("cursor","default")}},onUnLockHeadMove:function(b){var a=this.uht;this.hmx=b.xy[0]-(a?a.getXY()[0]+a.getScroll().left:0)+this.lockWidth;if(this.isOverSplitLine(this.hmx)){this.uh.setStyle("cursor","w-resize")}else{this.uh.setStyle("cursor","default")}},onHeadMouseDown:function(a){this.dragWidth=-1;if(this.overColIndex==undefined||this.overColIndex==-1){return}this.dragIndex=this.overColIndex;this.dragStart=a.getXY()[0];this.sp.setHeight(this.wrap.getHeight()).show().setStyle({top:this.wrap.getXY()[1]+"px",left:a.xy[0]+"px"});Ext.get(document.documentElement).on("mousemove",this.onHeadMouseMove,this).on("mouseup",this.onHeadMouseUp,this)},onHeadClick:function(i,n){var j=Ext.fly(n).parent("td"),a=this.dataset,c;if(j){c=j.getAttributeNS("","atype")}if(c=="grid.head"){var h=j.getAttributeNS("","dataindex"),b=this.findColByName(h);if(b&&b.sortable===true){if(a.isModified()){$A.showInfoMessage("提示","有未保存数据!");return}var k=j.child("div"),m=h,g="";if(this.currentSortTarget){this.currentSortTarget.removeClass(["grid-asc","grid-desc"])}this.currentSortTarget=k;if(Ext.isEmpty(b.sorttype)){b.sorttype="desc";k.removeClass("grid-asc").addClass("grid-desc");g="desc"}else{if(b.sorttype=="desc"){b.sorttype="asc";k.removeClass("grid-desc").addClass("grid-asc");g="asc"}else{b.sorttype="";k.removeClass(["grid-desc","grid-asc"])}}a.sort(m,g)}}else{if(c=="grid.rowcheck"){var f=j.child("div[atype=grid.headcheck]");if(f){var l=f.hasClass("item-ckb-c");this.setCheckBoxStatus(f,!l);if(!l){a.selectAll()}else{a.unSelectAll()}}}}},setRadioStatus:function(a,b){if(!b){a.removeClass("item-radio-img-c").addClass("item-radio-img-u")}else{a.addClass("item-radio-img-c").removeClass("item-radio-img-u")}},setCheckBoxStatus:function(a,b){if(!b){a.removeClass("item-ckb-c").addClass("item-ckb-u")}else{a.addClass("item-ckb-c").removeClass("item-ckb-u")}},setSelectDisable:function(c,b){var a=this.dataset.selected.indexOf(b)==-1;if(this.selectionmodel=="multiple"){c.removeClass(["item-ckb-c","item-ckb-u"]).addClass(a?"item-ckb-readonly-u":"item-ckb-readonly-c")}else{c.removeClass(["item-radio-img-c","item-radio-img-u","item-radio-img-readonly-c","item-radio-img-readonly-u"]).addClass(a?"item-radio-img-readonly-u":"item-radio-img-readonly-c")}},setSelectEnable:function(c,b){var a=this.dataset.selected.indexOf(b)==-1;if(this.selectionmodel=="multiple"){c.removeClass(["item-ckb-readonly-u","item-ckb-readonly-c"]).addClass(a?"item-ckb-u":"item-ckb-c")}else{c.removeClass(["item-radio-img-u","item-radio-img-c","item-radio-img-readonly-u","item-radio-img-readonly-c"]).addClass(a?"item-radio-img-u":"item-radio-img-c")}},setSelectStatus:function(b){if(this.dataset.selectfunction){var a=Ext.get(this.id+"__"+b.id);if(!this.dataset.execSelectFunction(b)){this.setSelectDisable(a,b)}else{this.setSelectEnable(a,b)}}},onHeadMouseMove:function(d){d.stopEvent();this.dragEnd=d.getXY()[0];var b=this.dragEnd-this.dragStart,f=this.columns[this.dragIndex],a=f.width+b;if(a>30&&a<this.width){this.dragWidth=a;this.sp.setStyle("left",d.xy[0]+"px")}},onHeadMouseUp:function(a){Ext.get(document.documentElement).un("mousemove",this.onHeadMouseMove,this).un("mouseup",this.onHeadMouseUp,this);this.sp.hide();if(this.dragWidth!=-1){this.setColumnSize(this.columns[this.dragIndex].name,this.dragWidth)}this.syncScroll()},findColByName:function(b){if(b){var e=this.columns;for(var d=0,a=e.length;d<a;d++){var f=e[d];if(f.name&&f.name.toLowerCase()===b.toLowerCase()){return f}}}return},selectRow:function(e,b){var d=this.dataset,a=d.getAt(e),c=(d.currentPage-1)*d.pagesize+e+1;this.selectedId=a.id;if(this.selectlockTr){this.selectlockTr.removeClass("row-selected")}if(this.selectUnlockTr){this.selectUnlockTr.removeClass("row-selected")}this.selectUnlockTr=Ext.get(this.id+"$u-"+a.id);if(this.selectUnlockTr){this.selectUnlockTr.addClass("row-selected")}this.selectlockTr=Ext.get(this.id+"$l-"+a.id);if(this.selectlockTr){this.selectlockTr.addClass("row-selected")}this.focusRow(e);this.selectRecord=a;if(b!==false&&c!=null){d.locate.defer(5,d,[c,false])}},setColumnSize:function(a,k){var f,e,c=0,b=0,d="width",g="px";Ext.each(this.columns,function(l){if(l.name&&l.name===a){if(l.hidden===true){return}l.width=k;if(l.lock!==true){f=this.uh.child("th[dataindex="+a+"]");e=this.ub.child("th[dataindex="+a+"]")}else{if(this.lh){f=this.lh.child("th[dataindex="+a+"]")}if(this.lb){e=this.lb.child("th[dataindex="+a+"]")}}}if(l.hidden!==true){l.lock!==true?(b+=l.width):(c+=l.width)}},this);this.wrap.select("td[dataindex="+a+"] DIV.grid-cell").each(function(l){l.setStyle(d,Math.max(k-(l.hasClass(this.cecls)?7:4),0)+g)},this);this.unlockWidth=b;this.lockWidth=c;if(f){f.setStyle(d,k+g)}if(e){e.setStyle(d,k+g)}var j=Math.max(this.width-c,0);if(this.fb){this.fb.child("th[dataindex="+a+"]").setStyle(d,k+g);this.uf.setStyle(d,j+g);this.fb.child("table[atype=fb.ubt]").setStyle(d,b+g);var i=this.fb.child("table[atype=fb.lbt]");if(i){this.fb.child("div[atype=grid.lf]").setStyle(d,(c-1)+g);i.setStyle(d,c+g)}}if(this.lc){var h=Math.max(c-1,0);this.lc.setStyle({width:h+g,display:h==0?"none":""})}if(this.lht){this.lht.setStyle(d,c+g)}if(this.lbt){this.lbt.setStyle(d,c+g)}this.uc.setStyle(d,j+g);this.uh.setStyle(d,j+g);this.ub.setStyle(d,j+g);this.uht.setStyle(d,b+g);if(this.ubt){this.ubt.setStyle(d,b+g)}this.syncSize()},drawFootBar:function(a){if(!this.fb){return}Ext.each([].concat(a?a:this.columns),function(f){var d=typeof(f)==="string"?this.findColByName(f):f;if(d&&d.footerrenderer){var e=$A.getRenderer(d.footerrenderer);if(e==null){alert("未找到"+d.footerrenderer+"方法!");return}var c=d.name,b=e.call(window,this.dataset.data,c);if(!Ext.isEmpty(b)){this.fb.child("td[dataindex="+c+"]").update(b)}}},this)},syncSize:function(){var b=0;Ext.each(this.columns,function(d){if(d.hidden!==true){if(d.lock===true){b+=d.width}}});if(b!=0){var a=this.width-b;this.uc.setWidth(a);this.uh.setWidth(a);this.ub.setWidth(a)}},classfiyColumns:function(){this.lockColumns=[],this.unlockColumns=[];this.lockWidth=0,this.unlockWidth=0;Ext.each(this.columns,function(a){if(a.lock===true){this.lockColumns.add(a);if(a.hidden!==true){this.lockWidth+=a.width}}else{this.unlockColumns.add(a);if(a.hidden!==true){this.unlockWidth+=a.width}}},this);this.columns=this.lockColumns.concat(this.unlockColumns)},showColumn:function(b){var a=this.findColByName(b);if(a){if(a.hidden===true){delete a.hidden;this.setColumnSize(b,a.hiddenwidth||a.width);delete a.hiddenwidth;this.wrap.select("td[dataindex="+b+"]").show()}}},hideColumn:function(b){var a=this.findColByName(b);if(a){if(a.hidden!==true){a.hiddenwidth=a.width;this.setColumnSize(b,0,false);this.wrap.select("td[dataindex="+b+"]").hide();a.hidden=true}}},removeColumn:function(a){var j=this.columns,k=[],g=[];Ext.each(a,function(i){col=this.findColByName(i);if(!col){return}if(col.lock){k.push(i)}else{g.push(i)}j.splice(j.indexOf(col),1)},this);var f=k.length,e=g.length;if(f||e){this.dataset.query();this.classfiyColumns();if(f){var b=this.lockWidth<1?1:this.lockWidth,c=[];for(var d=0;d<f;d++){c.push("[dataindex="+k[d]+"]")}this.lht.setWidth(this.lockWidth).select(c.join(",")).remove();this.lc.setWidth(b-1);this.uc.setWidth(this.wrap.getWidth()-b)}if(e){var c=[];for(var d=0;d<e;d++){c.push("[dataindex="+g[d]+"]")}this.uht.select(c.join(",")).remove()}var h=this.unLockWidth;this.uht.setWidth(h);this.uh.setWidth(h);this.ub.setWidth(h)}},createHead:Ext.isIE||Ext.isIE9?function(g,h,c,f,b){var a=f.query("tr"),d=Ext.fly(a[0]).child("th[width=20]"),e;if(c){e=f.query("[dataindex="+c+"]")[0]}if(h=="insertAfter"){e=e.nextSibling||null;b++}else{if(h=="append"){if(d){e=d.dom}b=-1}}Ext.each(g,function(m){var j=Ext.get(document.createElement("th")),l=Ext.get(a[1].insertCell(b)),i=m.width,k=m.name;if(b>-1){b++}l.addClass("grid-hc").set({dataindex:k,atype:"grid.head"}).update("<div>"+m.prompt+"</div>");if(e){a[0].insertBefore(j.dom,e)}else{a[0].appendChild(j.dom)}j.setStyle("width",i+"px").set({dataindex:k})})}:function(g,h,a,e){var b=[],d=[],c=e.query(h!="append"?"[dataindex="+a+"]":"tr");Ext.each(g,function(i){b.push('<th style="width:',i.width,'px;" dataindex="',i.name,'"></th>');d.push('<td class="grid-hc" atype="grid.head" dataindex="',i.name,'"><div>',i.prompt,"</div></td>")});new Ext.Template(b.join(""))[h](c[0],{});new Ext.Template(d.join(""))[h](c[1],{});var f=Ext.fly(c[0]).child("th[width=20]");if(f){f.appendTo(Ext.fly(c[0]))}},addColumn:function(o,b,f){if(this.dataset.isModified()){$A.showInfoMessage(_lang["grid.info"],_lang["grid.info.continue"])}else{var k=this.columns,g=k.length,n,l;if(b&&f){var d=this.findColByName(b);if(d){n=d.lock;l=this[n?"lockColumns":"unlockColumns"].indexOf(d);g=(f=="before"?0:1)+k.indexOf(d)}else{alert("未找到列"+b);return}}var m=[],e=[];Ext.each(o,function(r){var q=Ext.apply(Ext.apply({},this.defaultColumnOptions),r),p=this.findColByName(q.name);if(p){return}if(q.lock){m.push(q)}else{e.push(q)}},this);var c=m.concat(e);if(c.length){var a=f?(f=="before"?"insertBefore":"insertAfter"):"append",j=umethod=a,h=uname=b,i=this.wrap;if(n){umethod="insertBefore";uname=this.unlockColumns[0].name}else{j="append";h=null}this.columns=k.slice(0,g).concat(c).concat(k.slice(g));this.classfiyColumns();if(m.length){if(!this.lht){this.lc=new Ext.Template("<DIV class='grid-la' atype='grid.lc' style='width:24px;'><DIV class='grid-lh' atype='grid.lh' unselectable='on' onselectstart='return false;' style='height:25px;'><TABLE cellSpacing='0' atype='grid.lht' cellPadding='0' border='0' style='width:25px'><TBODY><TR class='grid-hl'></TR><TR height=25></TR></TBODY></TABLE></DIV><DIV class='grid-lb' atype='grid.lb' style='width:100%;height:255px'></DIV></DIV>").insertAfter(this.fs.dom,{},true);this.lh=i.child("div[atype=grid.lh]");this.lb=i.child("div[atype=grid.lb]");this.lht=i.child("table[atype=grid.lht]");this.lb.on("click",this.onClick,this)["on"]("dblclick",this.onDblclick,this);this.lht.on("mousemove",this.onLockHeadMove,this);this.lh.on("mousedown",this.onHeadMouseDown,this)["on"]("click",this.onHeadClick,this)}this.createHead(m,j,h,this.lht,l)}if(e.length){this.createHead(e,umethod,uname,this.uht,l)}if(this.lb){this.lb.update("")}this.ub.update("");Ext.each(c,function(p){this.setColumnSize(p.name,p.width)},this);this.dataset.query()}}},insertColumnBefore:function(b,a){this.addColumn(a,b,"before")},insertColumnAfter:function(b,a){this.addColumn(a,b,"after")},setWidth:function(c){if(this.width==c){return}this.width=c;this.wrap.setWidth(c);var b=$A.CmpManager.get(this.id+"_tb");if(b){b.setWidth(c)}var a=$A.CmpManager.get(this.id+"_navbar");if(a){a.setWidth(c)}if(this.fb){this.fb.setWidth(c)}var d=c-this.lockWidth;this.uc.setWidth(d);this.uh.setWidth(d);this.ub.setWidth(d);if(this.uf){this.uf.setWidth(d)}},setHeight:function(d){if(this.height==d){return}this.height=d;var b=$A.CmpManager.get(this.id+"_tb");if(b){d-=25}var a=$A.CmpManager.get(this.id+"_navbar");if(a){d-=25}if(this.fb){d-=25}this.wrap.setHeight(d);var c=d-25;if(this.lb){this.lb.setHeight(c)}this.ub.setHeight(c)},deleteSelectRows:function(b){var a=[].concat(this.dataset.getSelected());if(a.length>0){this.dataset.remove(a)}b.close()},remove:function(){var a=this.dataset.getSelected();if(a.length>0){$A.showConfirm(_lang["grid.remove.confirm"],_lang["grid.remove.confirmMsg"],this.deleteSelectRows.createDelegate(this))}},clear:function(){var a=this.dataset.getSelected();while(a[0]){this.dataset.removeLocal(a[0])}},_export:function(){this.showExportConfirm()},showExportConfirm:function(){this.initColumnPrompt();var b=this,e=0,d=this.id+"_export",c=['<div class="item-export-wrap" style="margin:15px;width:270px" id="',d,'">','<div class="grid-uh" atype="grid.uh" style="width: 270px; -moz-user-select: none; text-align: left; height: 25px; cursor: default;" onselectstart="return false;" unselectable="on">','<table cellSpacing="0" cellPadding="0" border="0"><tbody><tr height="25px">','<td class="export-hc" style="width:22px;" atype="export.rowcheck"><center><div atype="export.headcheck" class="grid-ckb item-ckb-',"u",'"></div></center></td>','<td class="export-hc" style="width:222px;" atype="grid-type">',_lang["grid.export.column"],"</td>","</tr></tbody></table></div>",'<div style="overflow:auto;height:200px;"><table cellSpacing="0" cellPadding="0" border="0"><tbody>'],a=true;Ext.each(this.columns,function(g,f){if(!this.isFunctionCol(g.type)){if(a){a=g.forexport!==false}c.push("<tr",(e+f)%2==0?"":' class="row-alt"','><td class="grid-rowbox" style="width:22px;" rowid="',f,'" atype="export.rowcheck"><center><div id="',this.id,"__",f,'" class="grid-ckb item-ckb-',g.forexport===false?"u":"c",'"></div></center></td><td><div class="grid-cell" style="width:220px">',g.prompt,"</div></td></tr>")}else{e++}},this);if(a){c[6]="c"}c.push("</tbody></table></div></div>");this.exportwindow=$A.showOkCancelWindow(_lang["grid.export.config"],c.join(""),function(f){$A.showConfirm(_lang["grid.export.confirm"],_lang["grid.export.confirmMsg"],function(g){b.doExport();g.close();f.body.un("click",b.onExportClick,b);f.close()});return false},null,null,300);this.exportwindow.body.on("click",this.onExportClick,this)},initColumnPrompt:function(){if(!this.isPromptInit){Ext.each(this.columns,function(a){if(!this.isFunctionCol(a.type)){a.prompt=a.name?this.wrap.child("td.grid-hc[dataindex="+a.name+"] div").dom.innerHTML:(a.prompt||this.dataset.getField(a.name).pro.prompt)}},this);this.isPromptInit=true}},onExportClick:function(d,k){var f=Ext.fly(k).parent("td");if(f){var a=f.getAttributeNS("","atype");if(a=="export.rowcheck"){var i=f.getAttributeNS("","rowid"),b=f.child("div"),h=b.hasClass("item-ckb-c"),c=b.getAttributeNS("","atype"),g=this.columns;this.setCheckBoxStatus(b,!h);if(c=="export.headcheck"){var j=(this.isFunctionCol(g[0].type)?1:0)+(this.isFunctionCol(g[1].type)?1:0);this.exportwindow.body.select("td[atype=export.rowcheck] div[atype!=export.headcheck]").each(function(e,m,l){this.setCheckBoxStatus(e,!h);g[l+j].forexport=!h},this)}else{g[i].forexport=!h}}}},doExport:function(){this.initColumnPrompt();$A.doExport(this.dataset,this.columns)},destroy:function(){$A.Grid.superclass.destroy.call(this);this.processDataSetLiestener("un");this.sp.remove();delete this.sp}});$A.Grid.revision="$Rev$";