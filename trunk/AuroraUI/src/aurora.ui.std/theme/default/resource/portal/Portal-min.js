(function(j){var m,l,b,r="display",f="none",n="",a="margin",g="margin-right",u="div.portal-proxy",c="table.portal-item-wrap",k="portal-item-btn-over",d="portal-item-btn-down",o="mousemove",i="mousedown",q="mouseup",h="beforeclose",t="close",p="itemclose",s="drag",e="drop";j.Portal=Ext.extend(j.Component,{portals:[],initComponent:function(v){j.Portal.superclass.initComponent.call(this,v);var x=this,w=x.wrap;x.proxy=w.child(u);w.select(c).each(function(y,z,A,B){x.createPortalItem(Ext.get(y.dom).id,x.items[A])})},initEvents:function(){j.Portal.superclass.initEvents.call(this);this.addEvents(p)},createPortalItem:function(y,w){var x=this,v=x.portals;v.push(new j.PortalItem(Ext.apply(w||{},{id:y,closeable:true,proxy:x.proxy,listeners:{close:function(A){var z=v.indexOf(A);v.splice(z,1);x.fireEvent(p,x,A,z)},drop:function(A,z){v.splice(v.indexOf(A),1);v.splice(z,0,A)}}})))},destroy:function(){var w=this,v=w.wrap;j.Portal.superclass.destroy.call(w);Ext.each(w.portals,function(x){x.destroy()})}});j.PortalItem=Ext.extend(j.Component,{constructor:function(v){j.Portal.superclass.constructor.call(this,v)},initComponent:function(v){j.PortalItem.superclass.initComponent.call(this,v);var x=this,w=x.wrap;x.cellspacing=parseFloat(w.getStyle(g));x.head=w.child("td.portal-item-caption-label");x.body=w.child("div.portal-item-content");x.closeBtn=x.wrap.child("div.portal-item-close");if(x.ref){x.load(x.ref)}},processListener:function(v){var w=this;j.PortalItem.superclass.processListener.call(w,v);if(w.closeable){w.closeBtn[v]("click",w.onCloseClick,w)[v]("mouseover",w.onCloseOver,w)[v]("mouseout",w.onCloseOut,w)[v](i,w.onCloseDown,w)}w.head[v](i,w.onMouseDown,w)},initEvents:function(){j.PortalItem.superclass.initEvents.call(this);this.addEvents(s,e,h,t)},showLoading:function(v){j.Masker.mask(v,_lang["tab.loading"])},clearLoading:function(v){j.Masker.unmask(v)},load:function(w){var x=this,v=this.body;v.cmps={};x.showLoading(v);Ext.Ajax.request({url:w,failure:function(y,z){x.clearLoading(v);var A=['<div style="text-align:center;line-height:30px">'];switch(y.status){case 404:A.push("<H2>",y.status,_lang["ajax.error"],"</H2>",_lang["ajax.error.404"]+'"'+y.statusText+'"');break;case 500:A.push("<H2>",y.status,_lang["ajax.error"],"</H2>",_lang["tab.internet.error"],"<a href=\"javascript:$('"+x.id+"').load('"+w+"')\">",_lang["tab.internet.refresh"],"</a>");break;case 0:break;default:A.push(_lang["ajax.error"],y.statusText);break}A.push("</div>");v.update(A.join(n))},success:function(y,A){var D;try{D=Ext.decode(y.responseText)}catch(E){}if(D&&D.success==false){if(D.error){if(D.error.code&&D.error.code=="session_expired"){j.showErrorMessage(_lang["ajax.error"],_lang["session.expired"])}else{j.manager.fireEvent("ajaxfailed",j.manager,A.url,A.para,D);var z=D.error.stackTrace,C=D.error.message;z=z?z.replaceAll("\r\n","</br>"):n;j.showErrorMessage(_lang["window.error"],C?C+"</br>"+z:z,null,400,C&&z==n?150:250)}}return}var B=y.responseText;v.update(B,true,function(){x.clearLoading(v);v.loaded=true},v)}})},close:function(){var v=this;if(v.fireEvent(h,v)){v.fireEvent(t,v);v.destroy()}},onMouseDown:function(y){if(this.animating){return}var w=this,z=y.xy,v=w.wrap,x=v.getXY();v.setStyle(a,n).setOpacity(0.9).position("absolute",999,x[0],x[1]);w.body.setStyle(r,f);m=z[0]-x[0];l=z[1]-x[1];w.proxy.insertBefore(v).setStyle(r,n);b=v.parent().query(c);Ext.fly(document).on(o,w.onMouseMove,w).on(q,w.onMouseUp,w);w.fireEvent(s,w,b.indexOf(v.dom))},onMouseMove:function(B){var A=this,E=B.xy,v=E[0],D=E[1],z=A.wrap,C=A.cellspacing/2,w=b.indexOf(z.dom);z.moveTo(v-m,D-l);Ext.each(b,function(y,F){if(y!=z.dom){y=Ext.fly(y);var H=y.getXY(),G=y.getWidth(),x=y.getHeight();if(v>H[0]-C&&v<H[0]+G+C&&D>H[1]-C&&D<H[1]+x+C){if(y.prev(u)){if(w>F){F+=1}A.proxy.insertAfter(y)}else{A.proxy.insertBefore(y);if(w<F){F-=1}}A.proxy.index=F;return false}}})},onMouseUp:function(w){var v=this,x=v.cellspacing;v.animating=true;v.wrap.setXY(v.proxy.getXY(),{callback:function(){v.wrap.insertBefore(v.proxy.setStyle(r,f)).clearPositioning().clearOpacity().setStyle(a,x+"px "+x+"px 0 0");v.body.setStyle(r,n);Ext.fly(document).un(o,v.onMouseMove,v).un(q,v.onMouseUp,v);v.fireEvent(e,v,v.proxy.index);b=null;v.proxy.index=null;delete v.animating},duration:0.15})},onCloseClick:function(v){v.stopEvent();this.close()},onCloseOver:function(v){this.closeBtn.addClass(k)},onCloseOut:function(v){this.closeBtn.removeClass(k)},onCloseDown:function(w){var v=this;v.closeBtn.removeClass(k).addClass(d);Ext.get(document.documentElement).on(q,v.onCloseUp,v)},onCloseUp:function(w){var v=this;v.closeBtn.removeClass(d);Ext.get(document.documentElement).un(q,v.onCloseUp,v)},clearBody:function(){Ext.iterate(this.body.cmps,function(v,w){if(w.destroy){try{w.destroy()}catch(x){alert("销毁portal出错: "+x)}}})},destroy:function(){var w=this,v=w.wrap;j.PortalItem.superclass.destroy.call(w);w.clearBody();v.setOpacity(0,{callback:function(){v.setStyle(g,0);v.setWidth(3,{callback:function(){v.remove()}})}})}})})($A);