(function(p){var x=document.documentElement,v=Ext.isEmpty,k=Ext.each,u=false,g=true,y=null,t="",z="_",o=" ",i="checkedvalue",s="cellcheck",b="-readonly",e="item-ckb",l="required",q="item-notBlank",c="item-invalid",w="cellclick",h="rowclick",j="keydown",n="select",m="mousedown",d="editorshow",a="nexteditorshow",f="未找到",r="方法!";p.GridBox=Ext.extend(p.Component,{constructor:function(A){p.GridBox.superclass.constructor.call(this,A)},initComponent:function(D){var G=this;p.GridBox.superclass.initComponent.call(G,D);var A=G.wrap,J=G.isfield,F=G.tbody=J?A.parent("tbody"):A.child("tbody"),I=G.tr=J?A.parent("tr").addClass("gridbox-row-end"):F.first(),B=G.btn=A.child(".gridbox-button"),H=0,E=G.column,K;k(G.columns,function(L){H+=Number(L.colspan)||1});G.rows=Math.ceil(H/E);B.dom.tabIndex=G.tabindex;B.setStyle({outline:"none"});G.rowposition=F.query("tr").indexOf(I.dom);G.initTemplate()},processDataSetLiestener:function(A){var B=this,D=B.dataset;if(D){D[A]("metachange",B.onLoad,B);D[A]("update",B.onUpdate,B);D[A]("reject",B.onUpdate,B);D[A]("add",B.onAdd,B);D[A]("load",B.onLoad,B);D[A]("valid",B.onValid,B);D[A]("remove",B.onRemove,B);D[A]("clear",B.onLoad,B);D[A]("refresh",B.onLoad,B)}},processListener:function(A){var B=this;p.GridBox.superclass.processListener.call(B,A);B.tbody[A]("click",B.onClick,B);B.btn[A](Ext.isOpera?"keypress":j,B.handleKeyDown,B)[A]("keyup",B.handleKeyUp,B)[A]("focus",B.onFocus,B)[A]("blur",B.onBlur,B);B[A](w,B.onCellClick,B)},bind:function(B){if(Ext.isString(B)){B=$(B);if(!B){return}}var A=this;A.dataset=B;A.processDataSetLiestener("on");A.onLoad()},handleKeyDown:function(E){var B=this,A=E.getKey(),D=B.dataset;if(E.ctrlKey&&E.keyCode==86&&B.canpaste){var F=window.clipboardData.getData("text");if(F){k(F.split("\n"),function(J){var H=J.split("\t");if(H==t){return}var I={},G=0;k(B.columns,function(K){if(B.isFunctionCol(K.type)){return}if(K.hidden!==g){I[K.name]=H[G];G++}});D.create(I)})}}else{if(A==9){B.showEditorByRecord()}else{if(A==38||A==40||A==33||A==34){if(D.loading==g){return}switch(E.getKey()){case 33:D.prePage();break;case 34:D.nextPage();break;case 38:if(!E.ctrlKey){D.pre()}break;case 40:if(!E.ctrlKey){D.next()}break}E.stopEvent()}}}B.fireEvent(j,B,E)},handleKeyUp:function(A){if(A.getKey()==9){this.showEditorByRecord()}},onFocus:function(){this.hasFocus=g},onBlur:function(){this.hasFocus=u},onValid:function(E,A,B,D){var G=this.findColByName(B);if(G){var F=Ext.get([this.id,B,A.id].join(z));if(F){if(D==u){F.addClass(c)}else{F.removeClass([q,c])}}}},onAdd:function(E,A,B){var D=this;D.createRow(A,B*(D.rows||1))},onRemove:function(D,A,B){this.tr.parent().select("[_row="+A.id+"]").remove()},onUpdate:function(G,A,B,F){var E=this,I=Ext.get([E.id,B,A.id].join(z));if(I){var H=E.findColByName(B),D=E.getEditor(H,A);if(D!=t&&($(D) instanceof p.CheckBox)){E.renderEditor(I,A,H,D)}else{I.update(E.renderText(A,H,F))}}k(E.columns,function(K){if(K.name!=B){var J=Ext.get([E.id,K.name,A.id].join(z));if(J){if(K.editorfunction){E.renderEditor(J,A,K,E.getEditor(K,A))}if(K.renderer){J.update(E.renderText(A,K,A.get(K.name)))}}}})},onLoad:function(){var A=this,B=A.dataset;A.clear();if(!B.getAll().length){B.create()}else{A.render()}},clear:function(){this.tr.parent().select("[_id="+this.id+"]").remove()},initTemplate:function(){this.cellTpl=new Ext.Template(['<div class="gridbox-cell {cellcls}" id="',this.id,'_{name}_{recordid}" style="width:{width}px">{text}</div>']);this.cbTpl=new Ext.Template(['<center><div class="{cellcls}" id="',this.id,'_{name}_{recordid}"></div></center>'])},render:function(){var A=this;k(A.dataset.getAll(),function(D,B){A.createRow(D,B*A.rows)})},renderPrompt:function(A,B,F){var E=B.promptrenderer;if(E){var D=p.getRenderer(E);if(D==y){alert(f+E+r);return F}F=D(F,A,B.name);return F==y?t:F}return F==y?t:F},renderEditor:function(E,A,D,B){this.createCell(E.dom,D,A)},renderText:function(A,B,F){var E=B.renderer;if(E){var D=p.getRenderer(E);if(D==y){alert(f+E+r);return F}F=D(F,A,B.name);return F==y?t:F}return F==y?t:F},createRow:function(D,G){var E=this,B=E.column,J=E.rowposition,F=0,I=E.tbody.dom.insertRow(G+J+1),A,K=1,H=false;Ext.fly(I).set({_row:D.id,_id:E.id},true);k(E.columns,function(L){F+=Number(L.colspan)||1;if(F>B){E.createCloseBtn(A,D);H=true;I=E.tbody.dom.insertRow(G+K+J+1);Ext.fly(I).set({_row:D.id,_id:E.id},true);F=Number(L.colspan)||1;K++}A=E.createCell(I,L,D)});I.className="gridbox-row-end";if(!H){E.createCloseBtn(A,D)}},createCloseBtn:function(B,A){new Ext.Template('<div class="gridbox-close-button" recordid="{recordid}"></div>').insertFirst(B,{recordid:A.id});B.addClass("gridbox-close-botton-wrap")},createCell:function(M,D,H){var I=this,A=document.createElement("th");A.className="layout-th";if(D){var B=I.renderPrompt(H,D,D.prompt);A.innerHTML="<div>"+B+(v(B)?t:I.labelseparator)+"</div>"}A.width=D.labelwidth||75;M.appendChild(A);if(M.tagName.toLowerCase()=="tr"){F=Ext.fly(M.insertCell(-1))}else{F=Ext.fly(M).parent("td")}F.addClass("layout-td-cell").setStyle({padding:this.padding+"px"});if(D){D.colspan&&F.set({colspan:D.colspan*2-1});var J=I.getEditor(D,H),E=D.type,L=D.name,G,O=t,F;if(J!=t){var K=p.CmpManager.get(J);if(K&&(K instanceof p.CheckBox)){E=s}else{O="item-tf item-wrap"}}else{if(L&&Ext.isDefined(H.getField(L).get(i))){E=s;G=g}}F.set({atype:"gridbox-cell",recordid:H.id,dataindex:L}).setStyle({"text-align":D.align||"left"});if(E==s){F.update(I.cbTpl.applyTemplate({cellcls:"gridbox-ckb "+I.getCheckBoxStatus(H,L,G),name:L,recordid:H.id}))}else{var N=H.getMeta().getField(L);if(N&&v(H.data[L])&&N.get(l)==g){O=O+o+q}F.update(I.cellTpl.applyTemplate({text:I.renderText(H,D,H.data[L]),cellcls:O,name:L,recordid:H.id,width:D.width||150}))}}return F},getCheckBoxStatus:function(A,E,D){var G=this.dataset.getField(E),B=G.getPropertity(i),F=A.data[E];return e+(D?b:t)+((F&&F==B)?C:U)},onClick:function(G,I){var F=this,H=I=Ext.fly(I),B=F.dataset,E;if(H.is("div.gridbox-close-button")){E=B.findById(H.getAttributeNS(t,"recordid"));p.showConfirm("提示","确认删除？",function(){B.remove(E)})}else{if(H.is("td[recordid]")||(H=H.parent("td[recordid]"))){var D=H.getAttributeNS(t,"atype");if(D=="gridbox-cell"){E=B.findById(H.getAttributeNS(t,"recordid"));var J=B.indexOf(E),A=H.getAttributeNS(t,"dataindex");F.fireEvent(w,F,J,A,E,!I.hasClass("gridbox-ckb"));F.fireEvent(h,F,J,E)}}}},onCellClick:function(D,E,B,A,F){this.showEditor(E,B,F)},setEditor:function(B,D){var E=this,A=E.findColByName(B),F=Ext.get([E.id,B,E.selectedId].join(z));A.editor=D;if(F){if(D==t){F.addClass("item-readOnly")}else{if(!$(D) instanceof p.CheckBox){F.removeClass("item-readOnly")}}}},getEditor:function(E,B){var D=E.editor||t;if(E.editorfunction){var A=window[E.editorfunction];if(A==y){alert(f+E.editorfunction+r);return y}D=A.call(window,B,E.name)||t}return D},positionEditor:function(){var D=this,B=D.currentEditor,A=B.editor,F=Ext.get([D.id,B.name,B.record.id].join(z)),E=F.getXY();if(A instanceof p.CheckBox){A.move(E[0],E[1]-4)}else{A.setHeight(F.getHeight()-2);A.setWidth(F.getWidth()-5<22?22:(F.getWidth()-5));A.move(E[0],E[1])}if(A.isExpanded&&A.isExpanded()){if(Ext.isIE){if(D.t){clearTimeout(D.t)}D.t=(function(){A.syncPopup()}).defer(1)}else{A.syncPopup()}}},hideEditor:function(){var E=this,D=E.currentEditor;if(D){var B=D.editor;if(B){if(!B.canHide||B.canHide()){B.el.un(j,E.onEditorKeyDown,E);B.un(n,E.onEditorSelect,E);Ext.fly(x).un(m,E.onEditorBlur,E);B.move(-10000,-10000);var A=B.autocompleteview;if(A){A.hide()}B.blur();B.onBlur();B.isFireEvent=u;B.isHidden=g;E.editing=u;if(B.collapse){B.collapse()}}}}},showEditor:function(J,A,I){if(J==-1){return}var G=this,D=G.findColByName(A);if(!D){return}var B=G.dataset,E=B.getAt(J);if(!E){return}if(E.id!=G.selectedId){G.selectRow(J)}var H=G.getEditor(D,E);G.setEditor(A,H);if(H!=t){var F=$(H);(function(){var L=E.get(A),N=Ext.get([G.id,A,E.id].join(z)),M=N.getXY(),K;F.bind(B,A);F.render(E);F.el.on(j,G.onEditorKeyDown,G);Ext.fly(x).on(m,G.onEditorBlur,G);K=G.currentEditor={record:E,ov:L,name:A,editor:F};G.positionEditor();if(F instanceof p.CheckBox){if(I){F.focus()}else{F.onClick()}}else{if(F instanceof p.Field&&!F instanceof p.TextArea){F.el.setStyle("text-align",D.align||"left")}else{if(F instanceof p.Lov){F.on("fetching",G.onFetching,G)}}F.isEditor=g;F.isFireEvent=g;F.isHidden=u;F.focus();F.on(n,G.onEditorSelect,G);if(Ext.isFunction(I)){I(F)}G.fireEvent(d,G,F,J,A,E)}G.editing=g}).defer(10)}},showEditorByRecord:function(A){var B=this,D=B.dataset,E=A?D.indexOf(A):0;A=A||D.getAt(0);if(!A&&B.autoappend){A=D.create()}if(A){k(B.columns,function(F){if(F.hidden!=g&&B.getEditor(F,A)!=t){B.fireEvent(w,B,E,F.name,A,function(){});B.fireEvent(h,B,E,A);return u}})}},onEditorBlur:function(E,B){var D=this,A=D.currentEditor;if(A&&!A.editor.isEventFromComponent(B)){D.hideEditor.defer(Ext.isIE9?10:0,D)}},onEditorSelect:function(){(function(){this.hideEditor()}).defer(1,this)},onEditorKeyDown:function(F,B){var D=this,E=F.keyCode;ced=D.currentEditor;if(E==27){if(ced){var A=ced.editor;if(A){A.clearInvalid();A.render(A.binder.ds.getCurrentRecord())}}D.hideEditor()}else{if(E==13){if(!(ced&&ced.editor&&ced.editor instanceof p.TextArea)){D.showEditorBy(39)}}else{if(E==9){F.stopEvent();D.showEditorBy(F.shiftKey?37:39)}else{if(F.ctrlKey&&(E==37||E==38||E==39||E==40)){D.showEditorBy(E);F.stopEvent()}}}}},showEditorBy:function(D){var E=this,G=g,B=E.findEditorBy(D);if(B){E.hideEditor();var F=B.row,A=B.record;E.fireEvent(w,E,F,B.name,A,G);E.fireEvent(h,E,F,A)}},findColByName:function(A){var B;if(A){k(this.columns,function(D){if(D.name&&D.name.toLowerCase()===A.toLowerCase()){B=D;return u}})}return B},findEditorBy:function(H){var K=this,B,J;if((B=K.currentEditor)&&(J=B.editor)){var N=K.columns,L=u,G=K.dataset,F=J.binder.name,A=J.record,P=G.data.indexOf(A),D=y,M=u,I=g,O=u,E;if(P!=-1){if(H==37||H==38){N=[].concat(N).reverse();I=u}if(H==38||H==40){O=g;E=K.findColByName(F)}while(A){if(!O){k(N,function(Q){if(L){if(Q.hidden!=g&&K.getEditor(Q,A)!=t){D=Q.name;return u}}else{if(Q.name==F){L=g}}})}if(D){return{row:P,name:D,record:A}}A=G.getAt(I?++P:--P);if(I&&!A&&!M&&K.autoappend){K.hideEditor();G.create();A=G.getAt(P);M=g}if(O&&A&&K.getEditor(E,A)!=t){D=F}}}}return y},selectRow:function(G,B){var E=this,F=E.dataset,A=F.getAt(G),D=(F.currentPage-1)*F.pagesize+G+1;E.selectedId=A.id;if(B!==u&&D!=y){F.locate.defer(5,F,[D,u])}}});p.GridBox.revision="$Rev: 8541 $"})($A);