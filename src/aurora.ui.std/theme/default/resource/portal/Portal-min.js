(function(l){var o,n,d,t="display",h="none",p="",b="margin",i="margin-right",x="div.portal-proxy",e="table.portal-item-wrap",m="portal-item-btn-over",f="portal-item-btn-down",q="mousemove",k="mousedown",s="mouseup",j="beforeclose",w="close",r="itemclose",v="itemclick",c="exchange",a="click",u="drag",g="drop";l.Portal=Ext.extend(l.Component,{portals:[],initComponent:function(y){l.Portal.superclass.initComponent.call(this,y);var A=this,z=A.wrap;A.proxy=z.child(x);z.select(e).each(function(B,C,D,E){A.createPortalItem(Ext.get(B.dom).id,A.items[D])})},initEvents:function(){l.Portal.superclass.initEvents.call(this);this.addEvents(r,v,c)},createPortalItem:function(B,z){var A=this,y=A.portals;y.push(new l.PortalItem(Ext.apply(z||{},{id:B,proxy:A.proxy,movable:A.movable,listeners:{close:function(D){var C=y.indexOf(D);y.splice(C,1);A.fireEvent(r,A,D,C)},click:function(C){A.fireEvent(v,A,C,y.indexOf(C))},drop:function(E,C){var D=y.indexOf(E);y.splice(y.indexOf(E),1);y.splice(C,0,E);!Ext.isEmpty(D)&&!Ext.isEmpty(C)&&A.fireEvent(c,A,D,C)}}})))},destroy:function(){var z=this,y=z.wrap;l.Portal.superclass.destroy.call(z);Ext.each(z.portals,function(A){A.destroy()})}});l.PortalItem=Ext.extend(l.Component,{initComponent:function(y){l.PortalItem.superclass.initComponent.call(this,y);var A=this,z=A.wrap;A.cellspacing=parseFloat(z.getStyle(i));A.head=z.child("td.portal-item-caption-label");A.body=z.child("div.portal-item-content");A.closeBtn=A.wrap.child("div.portal-item-close");if(A.ref){A.load(A.ref)}},processListener:function(y){var z=this;l.PortalItem.superclass.processListener.call(z,y);z.wrap[y](a,z.onClick,z);if(z.closeable){z.closeBtn[y](a,z.onCloseClick,z)[y]("mouseover",z.onCloseOver,z)[y]("mouseout",z.onCloseOut,z)[y](k,z.onCloseDown,z)}if(z.movable){z.head[y](k,z.onMouseDown,z)}},initEvents:function(){l.PortalItem.superclass.initEvents.call(this);this.addEvents(u,g,j,w,a)},showLoading:function(y){l.Masker.mask(y,_lang["tab.loading"])},clearLoading:function(y){l.Masker.unmask(y)},load:function(z){var A=this,y=this.body;y.cmps={};A.showLoading(y);Ext.Ajax.request({url:z,failure:function(B,C){A.clearLoading(y);var D=['<div style="text-align:center;line-height:30px">'];switch(B.status){case 404:D.push("<H2>",B.status,_lang["ajax.error"],"</H2>",_lang["ajax.error.404"]+'"'+B.statusText+'"');break;case 500:D.push("<H2>",B.status,_lang["ajax.error"],"</H2>",_lang["tab.internet.error"],"<a href=\"javascript:$('"+A.id+"').load('"+z+"')\">",_lang["tab.internet.refresh"],"</a>");break;case 0:break;default:D.push(_lang["ajax.error"],B.statusText);break}D.push("</div>");y.update(D.join(p))},success:function(B,D){var G;try{G=Ext.decode(B.responseText)}catch(H){}if(G&&G.success==false){if(G.error){if(G.error.code&&G.error.code=="session_expired"){l.showErrorMessage(_lang["ajax.error"],_lang["session.expired"])}else{l.manager.fireEvent("ajaxfailed",l.manager,D.url,D.para,G);var C=G.error.stackTrace,F=G.error.message;C=C?C.replaceAll("\r\n","</br>"):p;l.showErrorMessage(_lang["window.error"],F?F+"</br>"+C:C,null,400,F&&C==p?150:250)}}return}var E=B.responseText;y.update(E,true,function(){A.clearLoading(y);y.loaded=true},y)}})},close:function(){var y=this;if(y.fireEvent(j,y)){y.fireEvent(w,y);y.destroy()}},onClick:function(){var y=this;!y.moving&&y.fireEvent(a,y)},onMouseDown:function(B){if(this.animating){return}var z=this,C=B.xy,y=z.wrap,A=y.getXY();y.setStyle(b,p).setOpacity(0.9).position("absolute",999,A[0],A[1]);z.body.setStyle(t,h);o=C[0]-A[0];n=C[1]-A[1];z.proxy.insertBefore(y).setStyle(t,p);d=y.parent().query(e);Ext.fly(document).on(q,z.onMouseMove,z).on(s,z.onMouseUp,z);z.fireEvent(u,z,d.indexOf(y.dom))},onMouseMove:function(D){var C=this,G=D.xy,z=G[0],F=G[1],B=C.wrap,E=C.cellspacing/2,A=d.indexOf(B.dom);C.moving=true;B.moveTo(z-o,F-n);Ext.each(d,function(H,I){if(H!=B.dom){H=Ext.fly(H);var K=H.getXY(),J=H.getWidth(),y=H.getHeight();if(z>K[0]-E&&z<K[0]+J+E&&F>K[1]-E&&F<K[1]+y+E){if(H.prev(x)){if(A>I){I+=1}C.proxy.insertAfter(H)}else{C.proxy.insertBefore(H);if(A<I){I-=1}}C.proxy.index=I;return false}}})},onMouseUp:function(z){var y=this,A=y.cellspacing;y.animating=true;y.wrap.setXY(y.proxy.getXY(),{callback:function(){y.wrap.insertBefore(y.proxy.setStyle(t,h)).clearPositioning().clearOpacity().setStyle(b,A+"px "+A+"px 0 0");y.body.setStyle(t,p);Ext.fly(document).un(q,y.onMouseMove,y).un(s,y.onMouseUp,y);y.fireEvent(g,y,y.proxy.index);d=null;y.proxy.index=null;delete y.moving;delete y.animating},duration:0.15})},onCloseClick:function(y){y.stopEvent();this.close()},onCloseOver:function(y){this.closeBtn.addClass(m)},onCloseOut:function(y){this.closeBtn.removeClass(m)},onCloseDown:function(z){var y=this;y.closeBtn.removeClass(m).addClass(f);Ext.get(document.documentElement).on(s,y.onCloseUp,y)},onCloseUp:function(z){var y=this;y.closeBtn.removeClass(f);Ext.get(document.documentElement).un(s,y.onCloseUp,y)},clearBody:function(){Ext.iterate(this.body.cmps,function(y,z){if(z.destroy){try{z.destroy()}catch(A){alert("销毁portal出错: "+A)}}})},destroy:function(){var z=this,y=z.wrap;l.PortalItem.superclass.destroy.call(z);z.clearBody();y.setOpacity(0,{callback:function(){y.setStyle(i,0);y.setWidth(3,{callback:function(){y.remove()}})}})}});l.Portal.revision="$Rev$"})($A);