$A.Tab=Ext.extend($A.Component,{constructor:function(a){$A.Tab.superclass.constructor.call(this,a)},initComponent:function(a){$A.Tab.superclass.initComponent.call(this,a);this.scriptwidth=a.scriptwidth||60;this.head=this.wrap.child("div[atype=tab.strips]");this.body=this.wrap.child("div.item-tab-body");this.scrollLeft=this.wrap.child("div[atype=scroll-left]");this.scrollRight=this.wrap.child("div[atype=scroll-right]");this.script=this.head.parent();this.selectTab(a.selected||0)},processListener:function(a){$A.Tab.superclass.processListener.call(this,a);this.script.parent()[a]("mousedown",this.onMouseDown,this);this.script.parent()[a]("mouseup",this.onMouseUp,this);this.script.parent()[a]("mouseover",this.onMouseOver,this);this.script.parent()[a]("mouseout",this.onMouseOut,this);this.script[a]("click",this.onClick,this);this.script[a]("mousewheel",this.onMouseWheel,this)},initEvents:function(){$A.Tab.superclass.initEvents.call(this);this.addEvents("select","beforeopen")},selectTab:function(e){var a=this.getTab(e);if(!a){return}var d=a.strip,i=a.body;e=a.index;if(d){if(this.activeTab){this.activeTab.replaceClass("active","unactive")}this.activeTab=d;d.replaceClass("unactive","active");var b=d.dom.offsetLeft,g=d.getWidth(),c=this.script.getScroll().left,h=this.script.getWidth(),f=this.head.getWidth();tr=b+g-c-h,tl=c-b;if(tr>0){this.scrollRight.removeClass("scroll-disabled");this.scrollLeft.removeClass("scroll-disabled");this.script.scrollTo("left",c+tr)}else{if(tl>0){this.scrollLeft.removeClass("scroll-disabled");this.script.scrollTo("left",c-tl);this.scrollRight.removeClass("scroll-disabled")}}if(h+this.script.getScroll().left>=f){this.script.scrollTo("left",f-h);this.scrollRight.addClass("scroll-disabled")}else{if(e==0){this.script.scrollTo("left",0);this.scrollLeft.addClass("scroll-disabled")}}}if(i){if(this.activeBody){this.activeBody.setLeft("-10000px");this.activeBody.setTop("-10000px")}this.activeBody=i;i.setLeft("0px");i.setTop("0px")}if(this.items[e].ref&&i.loaded!=true){this.load(this.items[e].ref,i,e);i.loaded=true}else{this.fireEvent("select",this,e)}},stripTpl:['<div class="strip unactive"  unselectable="on" onselectstart="return false;">','<div class="strip-left"></div>','<div style="width:{stripwidth}px;" class="strip-center"><div class="tab-close"></div>{prompt}</div>','<div class="strip-right"></div>',"</div>"],bodyTpl:'<div style="width:{bodywidth}px;height:{bodyheight}px;left:-10000px;top:-10000px;" class="tab"></div>',openTab:function(e,a){var b=0;for(;b<this.items.length;b++){if(this.items[b].ref&&this.items[b].ref==e){this.selectTab(b);return}}var d=this.fireEvent("beforeopen",this,b);if(d!=false){this.items.push({ref:e});var f=$A.TextMetrics.measure(document.body,a).width+20;f=f<this.scriptwidth?this.scriptwidth:f;var c=this.head.getWidth()+f+6;this.head.setWidth(c);if(c>this.script.getWidth()){this.scrollLeft.setStyle({display:"block"});this.scrollRight.setStyle({display:"block"})}new Ext.Template(this.stripTpl).append(this.head.dom,{prompt:a,stripwidth:f});new Ext.Template(this.bodyTpl).append(this.body.dom,{bodywidth:this.body.getWidth(),bodyheight:this.body.getHeight()});this.selectTab(b)}},closeTab:function(g){var f=this.getTab(g);if(!f){return}var e=f.strip,a=f.body,c=f.index;if(!e.child("div.tab-close")){$A.showWarningMessage("警告","该Tab页无法被关闭!");return}this.items.splice(c,1);var d=this.head.getWidth()-e.getWidth(),b=a.cmps;this.head.setWidth(d);if(d<=this.script.getWidth()){this.scrollLeft.setStyle({display:"none"});this.scrollRight.setStyle({display:"none"})}e.remove();a.remove();this.activeBody=null;this.activeTab=null;delete a.loaded;setTimeout(function(){for(var h in b){var i=b[h];if(i.destroy){try{i.destroy()}catch(j){alert("销毁window出错: "+j)}}}},10);this.selectTab(c)},getTab:function(g){var c=Ext.DomQuery.select("div.tab",this.body.dom),f=Ext.DomQuery.select("div.strip",this.head.dom),e,a;if(Ext.isNumber(g)){if(g<0){g=0}else{g=Math.round(g)}if(!f[g]){g=f.length-1}e=Ext.get(f[g]);a=Ext.get(c[g])}else{g=Ext.get(g);for(var d=0,b=f.length;d<b;d++){if(Ext.get(f[d])==g){e=g;a=Ext.get(c[d]);g=d;break}}}return e?{strip:e,body:a,index:g}:null},scrollTo:function(a){if(a=="left"){this.script.scrollTo("left",this.script.getScroll().left-this.scriptwidth);this.scrollRight.removeClass("scroll-disabled");if(this.script.getScroll().left<=0){this.scrollLeft.addClass("scroll-disabled");this.scrollLeft.replaceClass("tab-scroll-left-over","tab-scroll-left");this.stopScroll()}}else{if(a=="right"){this.script.scrollTo("left",this.script.getScroll().left+this.scriptwidth);this.scrollLeft.removeClass("scroll-disabled");if(this.script.getScroll().left+this.script.getWidth()>=this.head.getWidth()){this.scrollRight.addClass("scroll-disabled");this.scrollRight.replaceClass("tab-scroll-right-over","tab-scroll-right");this.stopScroll()}}}},stopScroll:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);delete this.scrollInterval}},onClick:function(b){var a=Ext.get(b.target);if(a.hasClass("tab-close")){this.closeTab(a.parent().parent())}},onMouseWheel:function(a){var b=a.getWheelDelta();if(b>0){this.scrollTo("left");a.stopEvent()}else{this.scrollTo("right");a.stopEvent()}},onMouseDown:function(d){var b=Ext.get(d.target),a=Ext.get(d.target.parentNode),c=this;if(b.hasClass("tab-close")){b.removeClass("tab-btn-over");b.addClass("tab-btn-down")}else{if(b.hasClass("tab-scroll")&&!b.hasClass("scroll-disabled")){if(b.hasClass("tab-scroll-left-over")){c.scrollTo("left")}else{c.scrollTo("right")}c.scrollInterval=setInterval(function(){if(b.hasClass("tab-scroll")&&!b.hasClass("scroll-disabled")){if(b.hasClass("tab-scroll-left-over")){c.scrollTo("left")}else{c.scrollTo("right")}if(b.hasClass("scroll-disabled")){clearInterval(c.scrollInterval)}}},100)}else{if(a.hasClass("strip")&&!a.hasClass("active")){c.selectTab(a)}}}},onMouseUp:function(a){this.stopScroll()},onMouseOver:function(c){var b=Ext.get(c.target),a=Ext.get(c.target.parentNode);if(b.hasClass("tab-close")){b.show();b.addClass("tab-btn-over")}else{if(b.hasClass("tab-scroll")&&!b.hasClass("scroll-disabled")){if(b.hasClass("tab-scroll-left")){b.replaceClass("tab-scroll-left","tab-scroll-left-over")}else{if(b.hasClass("tab-scroll-right")){b.replaceClass("tab-scroll-right","tab-scroll-right-over")}}}else{if(a.hasClass("strip")){b=a.child("div.tab-close");if(b){b.show()}}}}},onMouseOut:function(c){var b=Ext.get(c.target),a=Ext.get(c.target.parentNode);if(b.hasClass("tab-close")){b.removeClass("tab-btn-over");b.removeClass("tab-btn-down")}else{if(b.hasClass("tab-scroll")&&!b.hasClass("scroll-disabled")){this.stopScroll();if(b.hasClass("tab-scroll-left-over")){b.replaceClass("tab-scroll-left-over","tab-scroll-left")}else{if((b.hasClass("tab-scroll-right-over"))){b.replaceClass("tab-scroll-right-over","tab-scroll-right")}}}else{if(a.hasClass("strip")){b=a.child("div.tab-close");if(b){b.hide()}}}}},showLoading:function(a){a.update(_lang["tab.loading"]);a.setStyle("text-align","center");a.setStyle("line-height",5)},clearLoading:function(a){a.update("");a.setStyle("text-align","");a.setStyle("line-height","")},load:function(c,e,b){c=c+(c.indexOf("?")!=-1?"&":"?")+"_vw="+this.width+"&_vh="+(this.height-Ext.fly(this.head).getHeight());var d=this,a=Ext.get(e);a.cmps={};d.showLoading(a);Ext.Ajax.request({url:c,success:function(f,g){var h=f.responseText;d.intervalId=setInterval(function(){if(!$A.focusTab){d.clearLoading(a);$A.focusTab=a;a.update(h,true,function(){$A.focusTab=null;d.fireEvent("select",d,b)});clearInterval(d.intervalId)}},10)}})},setWidth:function(e){e=Math.max(e,2);if(this.width==e){return}$A.Tab.superclass.setWidth.call(this,e);this.body.setWidth(e-2);this.script.setWidth(e-38);if(e-38<this.head.getWidth()){this.scrollLeft.setStyle({display:"block"});this.scrollRight.setStyle({display:"block"});var d=this.script.getScroll().left,c=this.script.getWidth(),b=this.head.getWidth();if(d<=0){this.scrollLeft.addClass("scroll-disabled")}else{this.scrollLeft.removeClass("scroll-disabled")}if(d+c>=b){if(!this.scrollRight.hasClass("scroll-disabled")){this.scrollRight.addClass("scroll-disabled")}else{this.script.scrollTo("left",b-c)}}else{this.scrollRight.removeClass("scroll-disabled")}}else{this.scrollLeft.setStyle({display:"none"});this.scrollRight.setStyle({display:"none"});this.script.scrollTo("left",0)}var f=Ext.DomQuery.select("div.tab",this.body.dom);for(var g=0;g<f.length;g++){var a=f[g];Ext.fly(a).setWidth(e-4)}},setHeight:function(d){d=Math.max(d,25);if(this.height==d){return}$A.Tab.superclass.setHeight.call(this,d);this.body.setHeight(d-26);var b=Ext.DomQuery.select("div.tab",this.body.dom);for(var c=0;c<b.length;c++){var a=b[c];Ext.fly(a).setHeight(d-28)}}});