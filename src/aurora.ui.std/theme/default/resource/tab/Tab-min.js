$A.Tab=Ext.extend($A.Component,{sd:"scroll-disabled",tslo:"tab-scroll-left-over",tsro:"tab-scroll-right-over",tsl:"tab-scroll-left",tsr:"tab-scroll-right",tc:"tab-close",tbo:"tab-btn-over",tbd:"tab-btn-down",ts:"tab-scroll",constructor:function(a){this.intervalIds=[];$A.Tab.superclass.constructor.call(this,a)},initComponent:function(b){$A.Tab.superclass.initComponent.call(this,b);this.scriptwidth=b.scriptwidth||60;var a=this.wrap,d=this.head=a.child("div[atype=tab.strips]"),c=this.script=d.parent();this.body=a.child("div.item-tab-body");this.scrollLeft=a.child("div[atype=scroll-left]");this.scrollRight=a.child("div[atype=scroll-right]");this.sp=c.parent();this.selectTab(b.selected||0)},processListener:function(a){$A.Tab.superclass.processListener.call(this,a);this.sp[a]("mousedown",this.onMouseDown,this)[a]("mouseup",this.onMouseUp,this)[a]("mouseover",this.onMouseOver,this)[a]("mouseout",this.onMouseOut,this);this.script[a]("click",this.onClick,this)[a]("mousewheel",this.onMouseWheel,this)},initEvents:function(){$A.Tab.superclass.initEvents.call(this);this.addEvents("select","beforeopen")},selectTab:function(g,n){var b=this.getTab(g);if(!b){return}var i=this.sd,g=b.index,f=b.strip,o=b.body;if(f.hasClass(i)){this.selectTab(g+1);return}this.selectedIndex=g;if(this.activeTab){this.activeTab.replaceClass("active","unactive")}this.activeTab=f;f.replaceClass("unactive","active");var j=this.script,e=this.scrollLeft,a=this.scrollRight,d=f.dom.offsetLeft,m=f.getWidth(),c=j.getScroll().left,k=j.getWidth(),h=this.head.getWidth();tr=d+m-c-k,tl=c-d;if(tr>0){a.removeClass(i);e.removeClass(i);j.scrollTo("left",c+tr)}else{if(tl>0){e.removeClass(i);j.scrollTo("left",c-tl);a.removeClass(i)}}if(k+j.getScroll().left>=h){j.scrollTo("left",h-k);a.addClass(i)}else{if(g==0){j.scrollTo("left",0);e.addClass(i)}}if(o){if(this.activeBody){this.activeBody.setLeft("-10000px").setTop("-10000px")}this.activeBody=o;o.setLeft("0px").setTop("0px")}if(this.items[g].ref&&(o.loaded!=true||n)){this.load(this.items[g].ref,o,g);o.loaded=true}else{this.fireEvent("select",this,g)}},stripTpl:['<div class="strip unactive"  unselectable="on" onselectstart="return false;"><div style="height:26px;width:{stripwidth2}px">','<div class="strip-left"></div>','<div style="width:{stripwidth}px;" class="strip-center"><div class="tab-close"></div>{prompt}</div>','<div class="strip-right"></div>',"</div></div>"],bodyTpl:'<div style="width:{bodywidth}px;height:{bodyheight}px;left:-10000px;top:-10000px;" class="tab"></div>',openTab:function(c,b){var e=0,h=this.items,d=h.length;for(;e<d;e++){var m=h[e];if(m.ref&&m.ref==c){this.selectTab(e);return}}if(this.fireEvent("beforeopen",this,d)!==false){h.push({ref:c});var f=Math.max($A.TextMetrics.measure(document.body,b).width+20,this.scriptwidth),k=this.head,g=this.body,j=this.script,a=k.getWidth()+f+6;k.setWidth(a);if(a>j.getWidth()){this.scrollLeft.setStyle({display:"block"});this.scrollRight.setStyle({display:"block"});j.setStyle("padding-left","1px")}new Ext.Template(this.stripTpl).append(k.dom,{prompt:b,stripwidth:f,stripwidth2:f+6});new Ext.Template(this.bodyTpl).append(g.dom,{bodywidth:g.getWidth(),bodyheight:g.getHeight()});this.selectTab(d)}},closeTab:function(h){var g=this.getTab(h);if(!g){return}var f=g.strip,a=g.body,c=g.index;if(!f.child("div."+this.tc)){$A.showWarningMessage("警告","该Tab页无法被关闭!");return}if(this.activeBody==g.body){this.activeBody=null;this.activeTab=null}this.items.splice(c,1);var d=this.head,b=this.script,e=d.getWidth()-f.getWidth();d.setWidth(e);if(e<=b.getWidth()){this.scrollLeft.setStyle({display:"none"});this.scrollRight.setStyle({display:"none"});b.setStyle("padding-left","0")}f.remove();a.remove();delete a.loaded;setTimeout(function(){Ext.iterate(a.cmps,function(i,j){if(j.destroy){try{j.destroy()}catch(k){alert("销毁Tab出错: "+k)}}})},10);this.selectTab(c)},destroy:function(){Ext.each(this.body.dom.children,function(a){Ext.iterate(Ext.fly(a).cmps,function(b,c){if(c.destroy){try{c.destroy()}catch(d){alert("销毁Tab出错: "+d)}}})});$A.Tab.superclass.destroy.call(this)},setDisabled:function(a){var c=this.getTab(a);if(!c){return}if(this.items.length>1){var b=c.strip,a=c.index;if(this.activeTab==b){this.selectTab(a+(this.getTab(a+1)?1:-1))}b.addClass(this.sd)}},setEnabled:function(a){var b=this.getTab(a);if(!b){return}b.strip.removeClass(this.sd)},getTab:function(e){var b=this.body.dom.children,d=this.head.dom.children,c,a;if(Ext.isNumber(e)){if(e<0){e+=d.length}e=Math.round(e);if(d[e]){c=Ext.get(d[e]);a=Ext.get(b[e])}}else{e=Ext.get(e);e=Ext.each(d,function(g,f){if(g==e.dom){c=e;a=Ext.get(b[f]);return false}})}return c?{strip:c,body:a,index:e}:null},scrollTo:function(e){var d=this.script,c=this.scrollRight,g=this.scrollLeft,b=d.getScroll().left,a=this.scriptwidth,f=this.sd;if(e=="left"){d.scrollTo("left",b-a);c.removeClass(f);if(d.getScroll().left<=0){g.addClass(f).replaceClass(this.tslo,this.tsl);this.stopScroll()}}else{if(e=="right"){d.scrollTo("left",b+a);g.removeClass(f);if(d.getScroll().left+d.getWidth()>=this.head.getWidth()){c.addClass(f).replaceClass(this.tsro,this.tsr);this.stopScroll()}}}},stopScroll:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);delete this.scrollInterval}},onClick:function(c,a){var b=Ext.fly(a);if(b.hasClass(this.tc)){this.closeTab(b.parent(".strip"))}},onMouseWheel:function(a){var b=a.getWheelDelta();if(b>0){this.scrollTo("left");a.stopEvent()}else{this.scrollTo("right");a.stopEvent()}},onMouseDown:function(f,a){var c=Ext.fly(a),b=c.parent(".strip"),d=this;if(c.hasClass(d.tc)){c.removeClass(d.tbo).addClass(d.tbd)}else{if(c.hasClass(d.ts)&&!c.hasClass(d.sd)){if(c.hasClass(d.tslo)){d.scrollTo("left")}else{d.scrollTo("right")}d.scrollInterval=setInterval(function(){if(c.hasClass(d.ts)&&!c.hasClass(d.sd)){if(c.hasClass(d.tslo)){d.scrollTo("left")}else{d.scrollTo("right")}if(c.hasClass(d.sd)){clearInterval(d.scrollInterval)}}},100)}else{if(b&&b.hasClass("strip")&&!b.hasClass("active")&&!b.hasClass(d.sd)){d.selectTab(b)}}}},onMouseUp:function(a){this.stopScroll()},onMouseOver:function(i,f){var h=Ext.fly(f),g=h.parent(".strip"),j=this.tsl,d=this.tsr,c=this.tc;if(h.hasClass(this.ts)&&!h.hasClass(this.sd)){if(h.hasClass(j)){h.replaceClass(j,this.tslo)}else{if(h.hasClass(d)){h.replaceClass(d,this.tsro)}}}else{if(h.hasClass(c)){h.addClass(this.tbo)}}if(g){h=g.child("div."+c);if(h){var a=this.currentBtn;if(a){a.hide()}this.currentBtn=h;h.show()}}},onMouseOut:function(h,d){var g=Ext.fly(d),f=g.parent(".strip"),b=this.tslo,c=this.tsro,a=this.tc;if(g.hasClass(this.ts)&&!g.hasClass(this.sd)){this.stopScroll();if(g.hasClass(b)){g.replaceClass(b,this.tsl)}else{if((g.hasClass(c))){g.replaceClass(c,this.tsr)}}}else{if(g.hasClass(a)){g.removeClass([this.tbo,this.tbd])}}if(f){g=f.child("div."+a);if(g){g.hide()}}},showLoading:function(a){a.setStyle({"text-align":"center","line-height":5}).update(_lang["tab.loading"])},clearLoading:function(a){a.setStyle({"text-align":"","line-height":""}).update("")},reloadTab:function(b,a){b=Ext.isEmpty(b)?this.selectedIndex:b;var c=this.getTab(b);if(!c){return}if(a){this.items[b].ref=a}Ext.iterate(c.body.cmps,function(d,f){if(f.destroy){try{f.destroy()}catch(g){alert("销毁Tab出错: "+g)}}});this.selectTab(b,true)},load:function(c,e,b){var d=this,a=Ext.get(e);a.cmps={};d.showLoading(a);Ext.Ajax.request({url:Ext.urlAppend(c,"_vw="+this.width+"&_vh="+(this.height-this.head.getHeight())),success:function(f,h){var k;try{k=Ext.decode(f.responseText)}catch(l){}if(k&&k.success==false){if(k.error){if(k.error.code&&k.error.code=="session_expired"){$A.showErrorMessage(_lang["ajax.error"],_lang["session.expired"])}else{$A.manager.fireEvent("ajaxfailed",$A.manager,h.url,h.para,k);var g=k.error.stackTrace,j=k.error.message;g=g?g.replaceAll("\r\n","</br>"):"";$A.showErrorMessage(_lang["window.error"],j?j+"</br>"+g:g,null,400,j&&g==""?150:250)}}return}var i=f.responseText;d.clearLoading(a);a.update(i,true,function(){d.fireEvent("select",d,b)},a)}})},setWidth:function(j){j=Math.max(j,2);if(this.width==j){return}$A.Tab.superclass.setWidth.call(this,j);var d=this.body,g=this.head,h=this.script,b=this.scrollLeft,a=this.scrollRight,f=this.sd;d.setWidth(j-2);h.setWidth(j-38);if(j-38<g.getWidth()){b.setStyle({display:"block"});a.setStyle({display:"block"});h.setStyle("padding-left","1px");var c=h.getScroll().left,i=h.getWidth(),e=g.getWidth();if(c<=0){b.addClass(f)}else{b.removeClass(f)}if(c+i>=e){if(!a.hasClass(f)){a.addClass(f)}else{h.scrollTo("left",e-i)}}else{a.removeClass(f)}}else{b.setStyle({display:"none"});a.setStyle({display:"none"});h.setStyle("padding-left","0").scrollTo("left",0)}Ext.each(d.dom.children,function(k){Ext.fly(k).setWidth(j-4)})},setHeight:function(b){b=Math.max(b,25);if(this.height==b){return}$A.Tab.superclass.setHeight.call(this,b);var a=this.body;a.setHeight(b-26);Ext.each(a.dom.children,function(c){Ext.fly(c).setHeight(b-28)})}});