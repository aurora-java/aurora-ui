$A.Table=Ext.extend($A.Component,{cecls:"table-cell-editor",nbcls:"item-notBlank",initComponent:function(a){$A.Table.superclass.initComponent.call(this,a);var b=this.wrap;this.cb=b.child("div[atype=table.headcheck]");this.tbody=b.child("tbody");this.fb=b.child("tfoot");this.initTemplate()},processListener:function(a){$A.Table.superclass.processListener.call(this,a);this.tbody[a]("click",this.onClick,this);if(this.canwheel){this.tbody[a]("mousewheel",this.onMouseWheel,this)}if(this.cb){this.cb[a]("click",this.onHeadClick,this)}this[a]("cellclick",this.onCellClick,this)},processDataSetLiestener:function(a){var b=this.dataset;if(b){b[a]("ajaxfailed",this.onAjaxFailed,this);b[a]("metachange",this.onLoad,this);b[a]("update",this.onUpdate,this);b[a]("reject",this.onUpdate,this);b[a]("add",this.onAdd,this);b[a]("submit",this.onBeforSubmit,this);b[a]("submitfailed",this.onAfterSuccess,this);b[a]("submitsuccess",this.onAfterSuccess,this);b[a]("query",this.onBeforeLoad,this);b[a]("load",this.onLoad,this);b[a]("loadfailed",this.onAjaxFailed,this);b[a]("valid",this.onValid,this);b[a]("beforeremove",this.onBeforeRemove,this);b[a]("remove",this.onRemove,this);b[a]("clear",this.onLoad,this);b[a]("refresh",this.onLoad,this);b[a]("fieldchange",this.onFieldChange,this);b[a]("indexchange",this.onIndexChange,this);b[a]("select",this.onSelect,this);b[a]("unselect",this.onUnSelect,this);b[a]("selectall",this.onSelectAll,this);b[a]("unselectall",this.onUnSelectAll,this)}},initEvents:function(){$A.Table.superclass.initEvents.call(this);this.addEvents("render","cellclick","rowclick","editorshow","nexteditorshow")},bind:function(a){if(typeof(a)==="string"){a=$(a);if(!a){return}}this.dataset=a;this.processDataSetLiestener("on");this.onLoad()},initTemplate:function(){this.cellTpl=new Ext.Template('<div class="table-cell {cellcls}" id="'+this.id+'_{name}_{recordid}">{text}</div>');this.cbTpl=new Ext.Template('<center><div class="{cellcls}" id="'+this.id+'_{name}_{recordid}"></div></center>')},createRow:function(c,f,e){var j="table-row-alt";if(e){var g=this.wrap.query("tbody tr");for(var b=f,a=g.length;b<a;b++){Ext.fly(g[b]).toggleClass(j).select(".table-rowbox").each(function(i){this.setSelectStatus(this.dataset.findById(i.getAttributeNS("","recordid")))},this)}}var h=this.tbody.dom.insertRow(f),d=this.parseCss(this.renderRow(c,f));h.id=this.id+"-"+c.id;h.style.cssText=d.style;h.className=(f%2==1?j+" ":"")+d.cls;Ext.each(this.columns,function(i){this.createCell(h,i,c)},this)},createEmptyRow:function(){this.emptyRow=this.tbody.dom.insertRow(-1);Ext.each(this.columns,function(a){Ext.fly(this.emptyRow.insertCell(-1)).set({atype:"table-cell",dataindex:a.name,style:"text-align:"+(a.align||"left")+(a.hidden?";display:none;":";")}).update("&#160;")},this)},removeEmptyRow:function(){if(this.emptyRow){this.tbody.dom.removeChild(this.emptyRow);this.emptyRow=null}},getCheckBoxStatus:function(a,d,c){var f=this.dataset.getField(d),b=f.getPropertity("checkedvalue"),e=a.data[d];return"item-ckb-"+(c?"readonly-":"")+((e&&e==b)?"c":"u")},createCell:function(i,a,e){var f=this.getEditor(a,e),b=a.type,h=a.name,d,k="",c;if(i.tagName.toLowerCase()=="tr"){c=i.insertCell(-1)}else{c=Ext.fly(i).parent("td").dom}if(f!=""){var g=$A.CmpManager.get(f);if(g&&(g instanceof $A.CheckBox)){b="cellcheck"}else{k="table-cell-editor"}}else{if(h&&Ext.isDefined(e.getField(h).get("checkedvalue"))){b="cellcheck";d=true}}if(b=="rowcheck"||b=="rowradio"){d=this.dataset.execSelectFunction(e)?"":"-readonly";Ext.fly(c).set({atype:b=="rowcheck"?"table.rowcheck":"table.rowradio",recordid:e.id,"class":"table-rowbox"});c.innerHTML=this.cbTpl.applyTemplate({cellcls:b=="rowcheck"?"table-ckb item-ckb"+d+"-u":"table-radio item-radio-img"+d+"-u",name:h,recordid:e.id})}else{Ext.fly(c).set({atype:"table-cell",recordid:e.id,dataindex:h,style:"text-align:"+(a.align||"left")+(a.hidden?";display:none;":";")});if(b=="cellcheck"){c.innerHTML=this.cbTpl.applyTemplate({cellcls:"table-ckb "+this.getCheckBoxStatus(e,h,d),name:h,recordid:e.id})}else{var j=e.getMeta().getField(h);if(j&&Ext.isEmpty(e.data[h])&&e.isNew==true&&j.get("required")==true){k=k+" "+this.nbcls}c.innerHTML=this.cellTpl.applyTemplate({text:this.renderText(e,a,e.data[h]),cellcls:k,name:h,recordid:e.id})}}},onSelect:function(c,b,d){if(!b||d){return}var a=Ext.get(this.id+"__"+b.id);a.parent(".table-rowbox").addClass("item-ckb-self");if(a){if(this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,true);this.setSelectStatus(b)}else{this.setRadioStatus(a,true);this.setSelectStatus(b);this.dataset.locate((this.dataset.currentPage-1)*this.dataset.pagesize+this.dataset.indexOf(b)+1)}}},onUnSelect:function(c,b,d){if(!b||d){return}var a=Ext.get(this.id+"__"+b.id);a.parent(".table-rowbox").addClass("item-ckb-self");if(a){if(this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,false);this.setSelectStatus(b)}else{this.setRadioStatus(a,false);this.setSelectStatus(b)}}},onSelectAll:function(){this.clearChecked();this.isSelectAll=true;this.isUnSelectAll=false;this.wrap.addClass("table-select-all")},onUnSelectAll:function(){this.clearChecked();this.isSelectAll=false;this.isUnSelectAll=true;this.wrap.removeClass("table-select-all")},clearChecked:function(){var a=this.wrap;a.select(".item-ckb-self .item-ckb-c").replaceClass("item-ckb-c","item-ckb-u");a.select(".item-ckb-self").removeClass("item-ckb-self")},setRadioStatus:function(a,b){if(!b){a.removeClass("item-radio-img-c").addClass("item-radio-img-u")}else{a.addClass("item-radio-img-c").removeClass("item-radio-img-u")}},setCheckBoxStatus:function(a,b){if(!b){a.removeClass("item-ckb-c").addClass("item-ckb-u")}else{a.addClass("item-ckb-c").removeClass("item-ckb-u")}},setSelectDisable:function(c,b){var a=this.dataset.selected.indexOf(b)==-1;if(this.selectionmodel=="multiple"){c.removeClass(["item-ckb-c","item-ckb-u"]).addClass(a?"item-ckb-readonly-u":"item-ckb-readonly-c")}else{c.removeClass(["item-radio-img-c","item-radio-img-u","item-radio-img-readonly-c","item-radio-img-readonly-u"]).addClass(a?"item-radio-img-readonly-u":"item-radio-img-readonly-c")}},setSelectEnable:function(c,b){var a=this.dataset.selected.indexOf(b)==-1;if(this.selectionmodel=="multiple"){c.removeClass(["item-ckb-readonly-u","item-ckb-readonly-c"]).addClass(a?"item-ckb-u":"item-ckb-c")}else{c.removeClass(["item-radio-img-u","item-radio-img-c","item-radio-img-readonly-u","item-radio-img-readonly-c"]).addClass(a?"item-radio-img-u":"item-radio-img-c")}},setSelectStatus:function(b){if(this.dataset.selectfunction){var a=Ext.get(this.id+"__"+b.id);if(!this.dataset.execSelectFunction(b)){this.setSelectDisable(a,b)}else{this.setSelectEnable(a,b)}}},onHeadClick:function(d){var a=this.cb,c=this.dataset,b=a.hasClass("item-ckb-c");this.setCheckBoxStatus(a,!b);if(!b){c.selectAll()}else{c.unSelectAll()}},setEditor:function(b,c){var a=this.findColByName(b),d=Ext.get(this.id+"_"+b+"_"+this.selectedId);a.editor=c;if(d){this.focusdiv=d;if(c==""){d.removeClass(this.cecls)}else{if(!$(c) instanceof $A.CheckBox){d.addClass(this.cecls)}}}},getEditor:function(d,b){var c=d.editor||"";if(d.editorfunction){var a=window[d.editorfunction];if(a==null){alert("未找到"+d.editorfunction+"方法!");return null}c=a.call(window,b,d.name)||""}return c},showEditor:function(j,a,i){if(j==-1){return}var b=this.findColByName(a);if(!b){return}var c=this.dataset.getAt(j);if(!c){return}if(c.id!=this.selectedId){this.selectRow(j)}var g=this.getEditor(b,c);this.setEditor(a,g);var f=this;if(f.currentEditor){f.currentEditor.editor.el.un("keydown",f.onEditorKeyDown,f);var h=f.currentEditor.focusCheckBox;if(h){h.setStyle("outline","none");f.currentEditor.focusCheckBox=null}}if(g!=""){var e=$(g);setTimeout(function(){var d=c.get(a),l=Ext.get(f.id+"_"+a+"_"+c.id),k=l.getXY();f.currentEditor={record:c,ov:d,name:a,editor:e};e.bind(f.dataset,a);e.render(c);if(e instanceof $A.CheckBox){e.move(-1000,k[1]+5);e.el.on("keydown",f.onEditorKeyDown,f);e.onClick();f.currentEditor.focusCheckBox=l;l.setStyle("outline","1px dotted blue")}else{if(g){f.positionEditor();e.isEditor=true;e.isFireEvent=true;e.isHidden=false;e.focus();f.editing=true;e.el.on("keydown",f.onEditorKeyDown,f);e.on("select",f.onEditorSelect,f);Ext.fly(document.documentElement).on("mousedown",f.onEditorBlur,f);Ext.fly(window).on("resize",f.positionEditor,f);if(i){i.call(window,e)}f.fireEvent("editorshow",f,e,j,a,c)}}},10)}},onEditorSelect:function(){var a=this;setTimeout(function(){a.hideEditor()},1)},onEditorKeyDown:function(d,b){var c=d.keyCode;if(c==27){if(this.currentEditor){var a=this.currentEditor.editor;if(a){a.clearInvalid();a.render(a.binder.ds.getCurrentRecord())}}this.hideEditor()}else{if(c==13){if(!(this.currentEditor&&this.currentEditor.editor&&this.currentEditor.editor instanceof $A.TextArea)){this.showNextEditor()}}else{if(c==9){d.stopEvent();this.showNextEditor()}}}},showNextEditor:function(){this.hideEditor();var n=this;if(n.currentEditor){var k=n.currentEditor.editor;if(k){var q=function(d){if(d instanceof $A.Lov){d.showLovWindow()}},g=n.dataset,f=k.binder.name,a=k.record,t=g.data.indexOf(a),b=null;if(t!=-1){var s=n.columns,c=0,m;for(var j=0,h=s.length;j<h;j++){if(s[j].name==f){c=j+1;break}}for(var j=c,h=s.length;j<h;j++){var e=s[j];if(e.hidden!=true){m=n.getEditor(e,a);if(m!=""){b=e.name;break}}}if(n.currentEditor){var o=n.currentEditor.focusCheckBox;if(o){o.setStyle("outline","none");n.currentEditor.focusCheckBox=null}}if(b){var k=$(m);if(k instanceof $A.CheckBox){n.currentEditor={record:a,ov:a.get(b),name:b,editor:k};setTimeout(function(){k.bind(g,b);k.render(a);var i=Ext.get([n.id,b,a.id].join("_")),d=i.getXY();k.move(-1000,d[1]);k.focus();k.el.on("keydown",n.onEditorKeyDown,n);n.currentEditor.focusCheckBox=i;i.setStyle("outline","1px dotted blue")},10)}else{n.fireEvent("cellclick",n,t,b,a,q)}}else{var p=g.getAt(t+1);if(!p&&n.autoappend!==false){g.create();p=g.getAt(t+1)}if(p){n.selectRow(t+1);for(var j=0,h=s.length;j<h;j++){var e=s[j],m=n.getEditor(e,p);if(m!=""){var k=$(m),b=e.name;if(k instanceof $A.CheckBox){n.currentEditor={record:p,ov:p.get(b),name:b,editor:k};setTimeout(function(){k.bind(g,b);k.render(p);var i=Ext.get([n.id,b,p.id].join("_")),d=i.getXY();k.move(-1000,d[1]);k.focus();k.el.on("keydown",n.onEditorKeyDown,n);n.currentEditor.focusCheckBox=i;i.setStyle("outline","1px dotted blue")},10)}else{n.fireEvent("cellclick",n,t+1,b,p,q)}break}}}}}n.fireEvent("nexteditorshow",n,t,b)}}},positionEditor:function(){var a=this.currentEditor.editor,c=this.focusdiv,b=c.getXY();a.setHeight(c.getHeight()-2);a.setWidth(c.getWidth()-5<22?22:(c.getWidth()-5));a.move(b[0],b[1]);if(a.isExpanded&&a.isExpanded()){if(Ext.isIE){if(this.t){clearTimeout(this.t)}this.t=setTimeout(function(){a.syncPopup()},1)}else{a.syncPopup()}}},hideEditor:function(){if(this.currentEditor&&this.editing){var a=this.currentEditor.editor;if(a){if(!a.canHide||a.canHide()){a.el.un("keydown",this.onEditorKeyDown,this);a.un("select",this.onEditorSelect,this);Ext.fly(document.documentElement).un("mousedown",this.onEditorBlur,this);Ext.fly(window).un("resize",this.positionEditor,this);a.move(-10000,-10000);a.onBlur();a.isFireEvent=false;a.isHidden=true;this.editing=false}}}},selectRow:function(e,b){var d=this.dataset,a=d.getAt(e),c=(d.currentPage-1)*d.pagesize+e+1;this.selectedId=a.id;if(this.selectTr){this.selectTr.removeClass("row-selected")}this.selectTr=Ext.get(this.id+"-"+a.id);if(this.selectTr){this.selectTr.addClass("row-selected")}this.selectRecord=a;if(b!==false&&c!=null){d.locate.defer(5,d,[c,false])}},drawFootBar:function(a){if(!this.fb){return}Ext.each([].concat((a)?a:this.columns),function(f){var d=typeof(f)==="string"?this.findColByName(f):f;if(d&&d.footerrenderer){var e=$A.getRenderer(d.footerrenderer);if(e==null){alert("未找到"+d.footerrenderer+"方法!");return}var c=d.name,b=e.call(window,this.dataset.data,c);if(!Ext.isEmpty(b)){this.fb.child("td[dataindex="+c+"]").update(b)}}},this)},showColumn:function(b){var a=this.findColByName(b);if(a){if(a.hidden===true){delete a.hidden;this.wrap.select("td[dataindex="+b+"]").setStyle("display","")}}},hideColumn:function(b){var a=this.findColByName(b);if(a){if(a.hidden!==true){this.wrap.select("td[dataindex="+b+"]").setStyle("display","none");a.hidden=true}}},findColByName:function(b){if(b){var e=this.columns;for(var d=0,a=e.length;d<a;d++){var f=e[d];if(f.name&&f.name.toLowerCase()===b.toLowerCase()){return f}}}return},parseCss:function(c){var e="",a="";if(Ext.isArray(c)){for(var b=0;b<c.length;b++){var d=this.parseCss(c[b]);e+=";"+d.style;a+=" "+d.cls}}else{if(typeof c=="string"){var f=!!c.match(/^([^,:;]+:[^:;]+;)*[^,:;]+:[^:;]+;*$/);a=f?"":c;e=f?c:""}}return{style:e,cls:a}},renderText:function(a,b,e){var d=b.renderer;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return e}e=c.call(window,e,a,b.name);return e==null?"":e}return e==null?"":e},renderRow:function(a,e){var d=this.rowrenderer,b=null;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return b}b=c.call(window,a,e);return !b?"":b}return b},renderEditor:function(e,a,d,b){this.createCell(e.dom,d,a)},onClick:function(h,k){var a=k.tagName.toUpperCase()=="TD",i=a?Ext.fly(k):Ext.fly(k).parent("td");if(i){var d=i.getAttributeNS("","atype"),j=i.getAttributeNS("","recordid"),c=this.dataset;if(d=="table-cell"){var g=c.findById(j),l=c.indexOf(g),b=i.getAttributeNS("","dataindex");this.fireEvent("cellclick",this,l,b,g);this.fireEvent("rowclick",this,l,g)}else{if(d=="table.rowcheck"){var f=Ext.get(this.id+"__"+j);if(f.hasClass("item-ckb-readonly-u")||f.hasClass("item-ckb-readonly-c")){return}if(this.isSelectAll&&!f.parent(".item-ckb-self")){f.replaceClass("item-ckb-u","item-ckb-c")}else{if(this.isUnselectAll&&!f.parent(".item-ckb-self")){f.replaceClass("item-ckb-c","item-ckb-u")}}f.hasClass("item-ckb-c")?c.unSelect(j):c.select(j)}else{if(d=="table.rowradio"){var f=Ext.get(this.id+"__"+j);if(f.hasClass("item-radio-img-readonly-u")||f.hasClass("item-radio-img-readonly-c")){return}c.select(j)}}}}},onCellClick:function(c,d,b,a,e){this.showEditor(d,b,e)},onUpdate:function(d,g,b,m){this.setSelectStatus(g);var a=Ext.get(this.id+"_"+b+"_"+g.id);if(a){var j=this.findColByName(b);var h=this.getEditor(j,g);if(h!=""&&($(h) instanceof $A.CheckBox)){this.renderEditor(a,g,j,h)}else{var n=this.renderText(g,j,m);a.update(n)}}var o=this.columns;for(var f=0,e=o.length;f<e;f++){var j=o[f];if(j.name!=b){var k=Ext.get(this.id+"_"+j.name+"_"+g.id);if(k){if(j.editorfunction){var h=this.getEditor(j,g);this.renderEditor(k,g,j,h)}if(j.renderer){var n=this.renderText(g,j,g.get(j.name));k.update(n)}}}}this.drawFootBar(b)},onLoad:function(){var c=this.wrap,e=this.dataset.data;this.clearBody();var a=c.removeClass("table-select-all").child("div[atype=table.headcheck]");if(a&&this.selectable&&this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,false)}var b=e.length;if(b==0){this.createEmptyRow()}else{for(var d=0;d<b;d++){this.createRow(e[d],d)}}this.drawFootBar();$A.Masker.unmask(c);this.fireEvent("render",this)},onValid:function(e,a,b,d){var g=this.findColByName(b);if(g){var f=Ext.get([this.id,b,a.id].join("_"));if(f){if(d==false){f.addClass("item-invalid")}else{f.removeClass([this.nbcls,"item-invalid"])}}}},onAdd:function(c,a,b){this.removeEmptyRow();this.createRow(a,b,b!==this.dataset.data.length-1);this.selectRow(this.dataset.indexOf(a));this.setSelectStatus(a)},onRemove:function(c,a,b){var d=Ext.get(this.id+"-"+a.id);if(d){d.remove()}this.selectTr=null;$A.Masker.unmask(this.wrap);this.drawFootBar()},clearBody:function(){while(this.tbody.dom.childNodes.length){this.tbody.dom.removeChild(this.tbody.dom.firstChild)}this.emptyRow=null},getDataIndex:function(c){for(var b=0,d=this.dataset.data,a=d.length;b<a;b++){if(d[b].id==c){return b}}return -1},onEditorBlur:function(b,a){if(this.currentEditor&&!this.currentEditor.editor.isEventFromComponent(a)){this.hideEditor.defer(Ext.isIE9?10:0,this)}},onMouseWheel:function(b){b.stopEvent();if(this.editing==true){return}var c=b.getWheelDelta(),a=this.dataset;if(c>0){a.pre()}else{if(c<0){a.next()}}},onIndexChange:function(c,b){var a=this.getDataIndex(b.id);if(a==-1){return}this.selectRow(a,false)},onFieldChange:function(d,a,e,b,c){if(b=="required"){var f=Ext.get([this.id,e.name,a.id].join("_"));if(f){f[c==true?"addClass":"removeClass"](this.nbcls)}}},onBeforeRemove:function(){$A.Masker.mask(this.wrap,_lang["grid.mask.remove"])},onBeforeLoad:function(){$A.Masker.mask(this.wrap,_lang["grid.mask.loading"])},onAfterSuccess:function(){$A.Masker.unmask(this.wrap)},onBeforSubmit:function(a){$A.Masker.mask(this.wrap,_lang["grid.mask.submit"])},onAjaxFailed:function(b,a){$A.Masker.unmask(this.wrap)}});