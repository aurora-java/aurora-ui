$A.Table=Ext.extend($A.Component,{bgc:"background-color",scor:"#dfeaf5",ocor:"#ffe3a8",cecls:"table-cell-editor",nbcls:"item-notBlank",initComponent:function(a){$A.Table.superclass.initComponent.call(this,a);var b=this.wrap;this.cb=b.child("div[atype=table.headcheck]");this.tbody=b.child("tbody");this.fb=b.child("tfoot");this.initTemplate()},processListener:function(a){$A.Table.superclass.processListener.call(this,a);this.tbody[a]("click",this.onClick,this);if(this.cb){this.cb[a]("click",this.onHeadClick,this)}},processDataSetLiestener:function(a){var b=this.dataset;if(b){b[a]("update",this.onUpdate,this);b[a]("add",this.onAdd,this);b[a]("load",this.onLoad,this);b[a]("valid",this.onValid,this);b[a]("remove",this.onRemove,this);b[a]("clear",this.onLoad,this);b[a]("select",this.onSelect,this);b[a]("unselect",this.onUnSelect,this)}},bind:function(a){if(typeof(a)==="string"){a=$(a);if(!a){return}}this.dataset=a;this.processDataSetLiestener("on");this.onLoad()},initTemplate:function(){this.cellTpl=new Ext.Template('<div class="table-cell {cellcls}" id="'+this.id+'_{name}_{recordid}">{text}</div>');this.cbTpl=new Ext.Template('<center><div class="{cellcls}" id="'+this.id+'_{name}_{recordid}"></div></center>')},createRow:function(b,c){var f=this.tbody.dom.insertRow(-1);var e=this.parseCss(this.renderRow(b,c));f.id=this.id+"-"+b.id;f.style.cssText=e.style;f.className=(c%2==1?"table-row-alt ":"")+e.cls;for(var d=0,a=this.columns.length;d<a;d++){this.createCell(f,this.columns[d],b)}},createEmptyRow:function(){this.emptyRow=this.tbody.dom.insertRow(-1);for(var b=0,a=this.columns.length;b<a;b++){var c=this.emptyRow.insertCell(-1);c.innerHTML="&#160;";Ext.fly(c).set({atype:"table-cell",dataindex:this.columns[b].name,style:"text-align:"+(this.columns[b].align||"left")+";visibility:visible;"})}},removeEmptyRow:function(){if(this.emptyRow){this.tbody.dom.removeChild(this.emptyRow);this.emptyRow=null}},getCheckBoxStatus:function(a,c){var f=this.dataset.getField(c);var b=f.getPropertity("checkedvalue");var d=f.getPropertity("uncheckedvalue");var e=a.data[c];return(e&&e==b)?"item-ckb-c":"item-ckb-u"},createCell:function(h,a,e){var i=e.getMeta().getField(a.name);if(i&&Ext.isEmpty(e.data[a.name])&&e.isNew==true&&i.get("required")==true){j=j+" "+this.nbcls}var f=this.getEditor(a,e),j=(f!=""?"table-cell-editor":""),c;if(h.tagName.toLowerCase()=="tr"){c=h.insertCell(-1)}else{c=h.parentNode}var g=$A.CmpManager.get(f),b=a.type;if(b=="rowcheck"||b=="rowradio"){var d="";if(!this.dataset.execSelectFunction(e)){d="-readonly"}Ext.fly(c).set({atype:b=="rowcheck"?"table.rowcheck":"table.rowradio",recordid:e.id,"class":"table-rowbox"});c.innerHTML=this.cbTpl.applyTemplate({cellcls:b=="rowcheck"?"table-ckb item-ckb"+d+"-u":"table-radio item-radio-img"+d+"-u",name:a.name,recordid:e.id})}else{Ext.fly(c).set({atype:"table-cell",recordid:e.id,dataindex:a.name,style:"text-align:"+(a.align||"left")+";visibility:visible;"});if(g&&(g instanceof $A.CheckBox)){c.innerHTML=this.cbTpl.applyTemplate({cellcls:"table-ckb "+this.getCheckBoxStatus(e,a.name),name:a.name,recordid:e.id})}else{c.innerHTML=this.cellTpl.applyTemplate({text:this.renderText(e,a,e.data[a.name]),cellcls:j,name:a.name,recordid:e.id})}}},onSelect:function(c,b){var a=Ext.get(this.id+"__"+b.id);if(a&&this.selectable&&this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,true)}else{this.setRadioStatus(a,true)}},onUnSelect:function(c,b){var a=Ext.get(this.id+"__"+b.id);if(a&&this.selectable&&this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,false)}else{this.setRadioStatus(a,false)}},setRadioStatus:function(a,b){if(!b){a.removeClass("item-radio-img-c");a.addClass("item-radio-img-u")}else{a.addClass("item-radio-img-c");a.removeClass("item-radio-img-u")}},setCheckBoxStatus:function(a,b){if(!b){a.removeClass("item-ckb-c");a.addClass("item-ckb-u")}else{a.addClass("item-ckb-c");a.removeClass("item-ckb-u")}},setSelectDisable:function(a){if(this.selectable&&this.selectionmodel=="multiple"){a.removeClass("item-ckb-c");a.removeClass("item-ckb-u");a.addClass("item-ckb-readonly-u")}else{a.removeClass("item-radio-img-c");a.removeClass("item-radio-img-u");a.addClass("item-radio-img-readonly-u")}},setSelectEnable:function(a){if(this.selectable&&this.selectionmodel=="multiple"){a.removeClass("item-ckb-readonly-u");a.addClass("item-ckb-u")}else{a.removeClass("item-radio-img-readonly-u");a.addClass("item-radio-img-u")}},setSelectStatus:function(b){if(this.dataset.selectfunction){var a=Ext.get(this.id+"__"+b.id);if(!this.dataset.execSelectFunction(b)){this.dataset.unSelect(b);this.setSelectDisable(a)}else{this.setSelectEnable(a)}}},onHeadClick:function(c){var a=this.cb;var b=a.hasClass("item-ckb-c");this.setCheckBoxStatus(a,!b);if(!b){this.dataset.selectAll()}else{this.dataset.unSelectAll()}},setEditor:function(b,c){var a=this.findColByName(b);a.editor=c;this.focusdiv=Ext.get(this.id+"_"+b+"_"+this.selectRecord.id);if(this.focusdiv){(c=="")?this.focusdiv.removeClass(this.cecls):this.focusdiv.addClass(this.cecls)}},getEditor:function(d,b){var c=d.editor||"";if(d.editorfunction){var a=window[d.editorfunction];if(a==null){alert("未找到"+d.editorfunction+"方法!");return null}c=a.call(window,b,d.name)}return c},showEditor:function(j,a){if(j==-1){return}var c=this.findColByName(a);if(!c){return}var e=this.dataset.getAt(j);if(!e){return}if(e.id!=this.selectedId){}this.selectRow(j);var g=this.getEditor(c,e);this.setEditor(a,g);if(g!=""&&($(g) instanceof $A.CheckBox)){var h=this.dataset.getField(a);var d=h.getPropertity("checkedvalue");var b=h.getPropertity("uncheckedvalue");var i=e.get(a);e.set(a,i==d?b:d)}else{if(g){var f=this;setTimeout(function(){var l=e.get(a);f.currentEditor={record:e,ov:l,name:a,editor:$(g)};var k=f.currentEditor.editor;if(k){f.positionEditor();k.isFireEvent=true;k.isHidden=false;k.bind(f.dataset,a);k.render(e);k.focus();Ext.fly(document.documentElement).on("mousedown",f.onEditorBlur,f);Ext.fly(window).on("resize",f.positionEditor,f)}f.fireEvent("editorshow",f,k,j,a,e)},1)}}},positionEditor:function(){var a=this.currentEditor.editor,d=this.focusdiv,c=d.getXY(),b=this;a.setHeight(d.getHeight()-2);a.setWidth(d.getWidth()-5<22?22:(d.getWidth()-5));a.move(c[0],c[1]);if(a.isExpanded&&a.isExpanded()){if(Ext.isIE){if(this.t){clearTimeout(this.t)}this.t=setTimeout(function(){a.syncPopup()},1)}else{a.syncPopup()}}},hideEditor:function(){if(this.currentEditor&&this.currentEditor.editor){var a=this.currentEditor.editor;a.un("blur",this.onEditorBlur,this);var b=true;if(a.canHide){b=a.canHide()}if(b){Ext.fly(document.documentElement).un("mousedown",this.onEditorBlur,this);Ext.fly(window).un("resize",this.positionEditor,this);var a=this.currentEditor.editor;a.move(-10000,-10000);a.isFireEvent=false;a.isHidden=true}}},selectRow:function(d,b){var a=this.dataset.getAt(d);this.selectedId=a.id;if(this.selectTr){this.selectTr.setStyle(this.bgc,"")}this.selectTr=Ext.get(this.id+"-"+a.id);if(this.selectTr){this.selectTr.setStyle(this.bgc,this.scor)}var c=(this.dataset.currentPage-1)*this.dataset.pagesize+d+1;this.selectRecord=a;if(b!==false&&c!=null){this.dataset.locate.defer(5,this.dataset,[c,false])}},drawFootBar:function(b){if(!this.fb){return}b=[].concat((b)?b:this.columns);var a=this;Ext.each(b,function(h){var e=typeof(h)==="string"?a.findColByName(h):h;if(e&&e.footerrenderer){var d=e.name;var g=$A.getRenderer(e.footerrenderer);if(g==null){alert("未找到"+e.footerrenderer+"方法!");return}var c=g.call(window,a.dataset.data,d);var f=a.fb.child("td[dataindex="+d+"]");f.update(c)}})},findColByName:function(d){var b;for(var e=0,a=this.columns.length;e<a;e++){var f=this.columns[e];if(f.name&&f.name.toLowerCase()===d.toLowerCase()){b=f;break}}return b},parseCss:function(c){var e="",a="";if(Ext.isArray(c)){for(var b=0;b<c.length;b++){var d=this.parseCss(c[b]);e+=";"+d.style;a+=" "+d.cls}}else{if(typeof c=="string"){isStyle=!!c.match(/^([^,:;]+:[^:;]+;)*[^,:;]+:[^:;]+;*$/);a=isStyle?"":c;e=isStyle?c:""}}return{style:e,cls:a}},renderText:function(a,b,e){var d=b.renderer;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return e}e=c.call(window,e,a,b.name);return e==null?"":e}return e==null?"":e},renderRow:function(a,e){var d=this.rowrenderer,b=null;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return b}b=c.call(window,a,e);return !b?"":b}return b},renderEditor:function(e,a,d,b){this.createCell(e.dom,d,a)},onClick:function(f){var g=Ext.fly(f.target).findParent("td");if(g){var b=Ext.fly(g).getAttributeNS("","atype");var i=Ext.fly(g).getAttributeNS("","recordid");if(b=="table-cell"){var d=this.dataset.findById(i);var j=this.dataset.indexOf(d);var a=Ext.fly(g).getAttributeNS("","dataindex");this.showEditor(j,a);this.fireEvent("cellclick",this,j,a,d);this.fireEvent("rowclick",this,j,d)}else{if(b=="table.rowcheck"){var c=Ext.get(this.id+"__"+i);if(c.hasClass("item-ckb-readonly-u")){return}var h=c.hasClass("item-ckb-c");(h)?this.dataset.unSelect(i):this.dataset.select(i)}else{if(b=="table.rowradio"){var c=Ext.get(this.id+"__"+i);if(c.hasClass("item-radio-img-readonly-u")){return}this.dataset.select(i)}}}}},onUpdate:function(d,g,b,m){var a=Ext.get(this.id+"_"+b+"_"+g.id);if(a){var j=this.findColByName(b);var h=this.getEditor(j,g);if(h!=""&&($(h) instanceof $A.CheckBox)){this.renderEditor(a,g,j,h)}else{var n=this.renderText(g,j,m);a.update(n)}}var o=this.columns;for(var f=0,e=o.length;f<e;f++){var j=o[f];if(j.name!=b){var k=Ext.get(this.id+"_"+j.name+"_"+g.id);if(k){if(j.editorfunction){var h=this.getEditor(j,g);this.renderEditor(k,g,j,h)}if(j.renderer){var n=this.renderText(g,j,g.get(j.name));k.update(n)}}}}this.drawFootBar(b)},onLoad:function(){this.clearBody();var a=this.dataset.data.length;if(a==0){this.createEmptyRow()}for(var b=0;b<a;b++){this.createRow(this.dataset.getAt(b),b)}this.drawFootBar()},onValid:function(e,a,b,d){var g=this.findColByName(b);if(g){var f=Ext.get(this.id+"_"+b+"_"+a.id);if(f){if(d==false){f.addClass("item-invalid")}else{f.removeClass([this.nbcls,"item-invalid"])}}}},onAdd:function(c,a,b){this.removeEmptyRow();this.createRow(a,this.dataset.data.length-1);this.selectRow(this.dataset.indexOf(a))},onRemove:function(c,a,b){var d=Ext.get(this.id+"-"+a.id);if(d){d.remove()}this.selectTr=null;this.drawFootBar()},clearBody:function(){while(this.tbody.dom.childNodes.length){this.tbody.dom.removeChild(this.tbody.dom.firstChild)}},onEditorBlur:function(a){if(this.currentEditor&&!this.currentEditor.editor.isEventFromComponent(a.target)){this.hideEditor()}}});